<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ChiefAIOfficer - Sales Dashboard v2.3</title>
    <style>
        :root {
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --green: #10b981;
            --green-bg: rgba(16, 185, 129, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* NAV */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .nav-brand img {
            height: 32px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-user .status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--blue-bg);
            color: var(--blue);
        }

        /* MAIN LAYOUT */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* CONSTRAINT BANNER */
        .constraint-banner {
            background: linear-gradient(135deg, var(--red-bg), transparent);
            border: 1px solid var(--red);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .constraint-banner.success {
            background: linear-gradient(135deg, var(--green-bg), transparent);
            border-color: var(--green);
        }

        .constraint-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .constraint-icon {
            font-size: 32px;
        }

        .constraint-text h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .constraint-text p {
            font-size: 18px;
            font-weight: 600;
        }

        .constraint-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* SCORECARD GRID */
        .scorecard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .scorecard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .scorecard {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .metric-status {
            font-size: 18px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-value.green {
            color: var(--green);
        }

        .metric-value.yellow {
            color: var(--yellow);
        }

        .metric-value.red {
            color: var(--red);
        }

        .metric-target {
            font-size: 12px;
            color: var(--text-muted);
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            margin-top: 8px;
        }

        .metric-trend.up {
            color: var(--green);
        }

        .metric-trend.down {
            color: var(--red);
        }

        /* PENDING APPROVALS SECTION */
        .section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .section-badge {
            background: var(--red);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* PRIORITY BADGES */
        .priority-hot {
            background: var(--red);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-warm {
            background: var(--yellow);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-low {
            background: var(--green);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* SEGMENT FILTERS */
        .filter-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--blue-bg);
            border-color: var(--blue);
            color: var(--blue);
        }

        /* BULK ACTIONS */
        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        /* EMAIL QUEUE */
        .email-list {
            padding: 0;
        }

        .email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .email-item:hover {
            background: var(--bg-hover);
        }

        .email-item:last-child {
            border-bottom: none;
        }

        .email-info {
            flex: 1;
        }

        .email-subject {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .email-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }

        .email-tier {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .email-tier.tier1 {
            background: var(--green-bg);
            color: var(--green);
        }

        .email-tier.tier2 {
            background: var(--blue-bg);
            color: var(--blue);
        }

        .email-tier.tier3 {
            background: var(--yellow-bg);
            color: var(--yellow);
        }

        .email-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-approve {
            background: var(--green);
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-reject {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--red);
            cursor: pointer;
        }

        .btn-reject:hover {
            background: var(--red-bg);
        }

        .btn-preview {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .btn-preview:hover {
            background: var(--bg-hover);
        }

        /* TWO COLUMN LAYOUT */
        .two-col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* ACTIVITY FEED */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.sent {
            background: var(--green-bg);
        }

        .activity-icon.reply {
            background: var(--blue-bg);
        }

        .activity-icon.meeting {
            background: var(--yellow-bg);
        }

        .activity-text {
            flex: 1;
        }

        .activity-text p {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .activity-text span {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* EMAIL PREVIEW MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-sidebar {
            background: var(--bg-dark);
            border-left: 1px solid var(--border);
            padding-left: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .email-preview-field {
            margin-bottom: 16px;
        }

        .email-preview-field label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .email-preview-field .value {
            font-size: 14px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .email-preview-field .body {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* EMAIL BODY EDIT STYLES - FOR HTML RENDERING FIX */
        .body-edit {
            width: 100%;
            min-height: 200px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
            overflow-y: auto;
        }

        .body-edit p {
            margin-bottom: 1em;
        }

        .body-edit ul,
        .body-edit ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .body-edit li {
            margin-bottom: 4px;
        }

        .body-edit a {
            color: var(--blue);
            text-decoration: underline;
            cursor: pointer;
        }

        .body-edit br {
            display: block;
            content: "";
            margin-top: 0.5em;
        }

        .body-edit strong,
        .body-edit b {
            font-weight: 600;
            color: var(--text-primary);
        }

        .body-edit em,
        .body-edit i {
            font-style: italic;
        }

        .body-edit blockquote {
            border-left: 3px solid var(--blue);
            padding-left: 12px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        .body-edit:focus {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        .body-edit img {
            max-width: 100%;
            height: auto;
        }

        .body-edit:empty:before {
            content: "Click to edit email body...";
            color: var(--text-muted);
            font-style: italic;
        }

        .feedback-input {
            width: 100%;
            min-height: 80px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            margin-top: 4px;
        }

        /* SIDEBAR LAYOUT */
        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-field {
            margin-bottom: 12px;
        }

        .sidebar-field label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .sidebar-field .value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="nav-brand">
            <span>üìä</span>
            <span>ChiefAIOfficer Sales Dashboard <small
                    style="font-size:11px; color:#666; margin-left:8px;">v2.3</small></span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('emails')">Email Queue</button>
            <button class="nav-tab" onclick="showTab('campaigns')">Campaigns</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>
        <div class="nav-user">
            <div class="status">
                <span class="dot"></span>
                <span>Swarm Active</span>
            </div>
            <span style="color: var(--text-secondary); font-size: 14px;">Dani Apgar</span>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <div class="constraint-banner" id="constraintBanner">
            <div class="constraint-left">
                <span class="constraint-icon">‚ö†Ô∏è</span>
                <div class="constraint-text">
                    <h3>Your #1 Constraint</h3>
                    <p id="constraintMessage">Reply Rate below target (6.5% vs 8% target)</p>
                </div>
            </div>
            <div class="constraint-actions">
                <button class="btn btn-primary" onclick="viewConstraintFix()">View Fix</button>
                <button class="btn btn-secondary" onclick="snoozeConstraint()">Snooze 24h</button>
            </div>
        </div>

        <!-- SCORECARD -->
        <div class="scorecard">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Emails Sent</span>
                    <span class="metric-status">üìß</span>
                </div>
                <div class="metric-value green" id="emailsSent">847</div>
                <div class="metric-target">Target: 2,500/mo ‚Ä¢ 34% of limit</div>
                <div class="metric-trend up">‚Üë 12% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Reply Rate</span>
                    <span class="metric-status">üí¨</span>
                </div>
                <div class="metric-value yellow" id="replyRate">6.5%</div>
                <div class="metric-target">Target: 8%</div>
                <div class="metric-trend down">‚Üì 0.8% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Meetings Booked</span>
                    <span class="metric-status">üìÖ</span>
                </div>
                <div class="metric-value green" id="meetingsBooked">12</div>
                <div class="metric-target">Target: 15/mo</div>
                <div class="metric-trend up">‚Üë 3 vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Pipeline Value</span>
                    <span class="metric-status">üí∞</span>
                </div>
                <div class="metric-value green" id="pipelineValue">$142K</div>
                <div class="metric-target">Target: $200K/mo</div>
                <div class="metric-trend up">‚Üë $28K vs last week</div>
            </div>
        </div>

        <div class="two-col">
            <!-- PENDING APPROVALS -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üì• Pending Email Approvals</h2>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterEmails('all')">All</button>
                        <button class="filter-btn" onclick="filterEmails('hot')">üî¥ Hot</button>
                        <button class="filter-btn" onclick="filterEmails('warm')">üü° Warm</button>
                        <button class="filter-btn" onclick="filterEmails('low')">üü¢ Low</button>
                        <span class="section-badge" id="pendingCount">3</span>
                        <div class="bulk-actions">
                            <button class="btn-sm btn-primary" onclick="bulkApprove()">‚úÖ Approve All Low</button>
                        </div>
                    </div>
                </div>
                <div class="email-list" id="emailList">
                    <!-- Email items populated by JS -->
                </div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üîî Recent Activity</h2>
                </div>
                <div id="activityFeed">
                    <!-- Activity items populated by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- EMAIL PREVIEW MODAL -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Email Editor &amp; Preview</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="emailPreviewBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-reject btn-sm" onclick="rejectEmail()">Reject</button>
                <button class="btn btn-approve" onclick="approveEmail()">‚úì Approve &amp; Send</button>
            </div>
        </div>
    </div>

    <!-- Error Reporter for debug-mcp correlation -->
    <script src="/static/error-reporter.js"></script>
    <script>
        const pendingEmails = [];
        const recentActivity = [];

        async function fetchPendingEmails() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                const response = await fetch(`/api/pending-emails?auth_token=${token}&token=${token}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.pending_emails && data.pending_emails.length > 0) {
                        pendingEmails.length = 0;
                        data.pending_emails.forEach(e => {
                            pendingEmails.push({
                                id: e.email_id,
                                tier: e.tier || 'tier1',
                                tierLabel: (e.tier || 'Tier 1').toUpperCase(),
                                subject: e.subject,
                                recipient: e.to,
                                recipientName: e.recipient_data?.name || e.to.split('@')[0],
                                company: e.recipient_data?.company || 'Unknown Corp',
                                title: e.recipient_data?.title || 'Unknown Title',
                                location: e.recipient_data?.location || 'Unknown Location',
                                employees: e.recipient_data?.employees || 'N/A',
                                industry: e.recipient_data?.industry || 'N/A',
                                angle: e.angle || 'General',
                                timestamp: 'Just now',
                                body: e.body
                            });
                        });
                        renderPendingEmails();
                    }
                }
            } catch (e) {
                console.error("Failed to fetch pending emails:", e);
            }
        }

        fetchPendingEmails();

        function getToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        function renderPendingEmails() {
            const list = document.getElementById('emailList');
            const filteredEmails = currentFilter === 'all'
                ? pendingEmails
                : pendingEmails.filter(e => classifyPriority(e) === currentFilter);

            if (filteredEmails.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <h3>All caught up!</h3>
                        <p>No pending emails to review</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '0';
                return;
            }

            document.getElementById('pendingCount').textContent = filteredEmails.length;

            list.innerHTML = filteredEmails.map(email => `
                <div class="email-item">
                    <div class="email-info">
                        <div class="email-subject">
                            ${getPriorityBadge(email)}
                            <span class="email-tier ${email.tier}">${email.tierLabel}</span>
                            ${email.subject}
                        </div>
                        <div class="email-meta">
                            <span>To: ${email.recipientName} (${email.company})</span>
                            <span>Angle: ${email.angle}</span>
                            <span>${email.timestamp}</span>
                        </div>
                    </div>
                    <div class="email-actions">
                        <button class="btn-sm btn-preview" onclick="previewEmail('${email.id}')">Edit & Preview</button>
                    </div>
                </div>
            `).join('');
        }

        function renderActivityFeed() {
            const feed = document.getElementById('activityFeed');
            if (recentActivity.length === 0) {
                feed.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon sent">üìß</div>
                        <div class="activity-text">
                            <p>Swarm is running. Waiting for activity...</p>
                            <span>Live Mode (Limit 25/day)</span>
                        </div>
                    </div>
                `;
                return;
            }

            feed.innerHTML = recentActivity.map(act => `
                <div class="activity-item">
                    <div class="activity-icon ${act.type}">${act.icon}</div>
                    <div class="activity-text">
                        <p>${act.message}</p>
                        <span>${act.time}</span>
                    </div>
                </div>
            `).join('');
        }

        let currentEmailId = null;

        function previewEmail(emailId) {
            currentEmailId = emailId;
            const email = pendingEmails.find(e => e.id === emailId);
            if (!email) return;

            document.getElementById('emailPreviewBody').innerHTML = `
                <div class="modal-main">
                    <!-- TO -->
                    <div class="email-preview-field">
                        <label>To</label>
                        <div class="value">${email.recipientName} &lt;${email.recipient}&gt;</div>
                    </div>
                    <!-- SUBJECT -->
                    <div class="email-preview-field">
                        <label>Subject</label>
                        <div class="value">${email.subject}</div>
                    </div>
                    <!-- EDITABLE BODY -->
                    <div class="email-preview-field">
                        <label>Email Body (Click to Edit)</label>
                        <div id="emailBodyInput" class="body-edit" contenteditable="true">${email.body}</div>
                    </div>
                    <!-- FEEDBACK -->
                    <div class="email-preview-field">
                        <label>Feedback for AI (Help the Agents Learn)</label>
                        <textarea id="feedbackInput" class="feedback-input" placeholder="e.g. 'Good angle, but make the intro shorter next time' or 'This person is not a decision maker'"></textarea>
                    </div>
                </div>
                <div class="modal-sidebar">
                    <div class="sidebar-title">Lead Insights</div>
                    <div class="sidebar-field">
                        <label>Target</label>
                        <div class="value">${email.recipientName}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Title</label>
                        <div class="value">${email.title}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Company</label>
                        <div class="value">${email.company}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Employees</label>
                        <div class="value">${email.employees}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Location</label>
                        <div class="value">${email.location}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Angle Used</label>
                        <div class="value"><span class="email-tier ${email.tier}">${email.tierLabel}</span> ${email.angle}</div>
                    </div>

                    <div class="sidebar-title" style="margin-top: 24px;">Actions</div>
                    <button class="btn-sm btn-secondary" style="width:100%">üîó View LinkedIn</button>
                    <button class="btn-sm btn-secondary" style="width:100%; margin-top:8px;">üè¢ View Website</button>
                </div>
            `;

            document.getElementById('emailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('emailModal').classList.remove('active');
            currentEmailId = null;
        }

        async function approveEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const editedBody = document.getElementById('emailBodyInput').innerHTML;
            const feedback = document.getElementById('feedbackInput').value;

            closeModal();
            const index = pendingEmails.findIndex(e => e.id === emailId);
            if (index > -1) pendingEmails.splice(index, 1);
            renderPendingEmails();

            try {
                const response = await fetch(`/api/emails/${emailId}/approve?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        edited_body: editedBody,
                        feedback: feedback
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }
            } catch (e) {
                alert('Error approving email: ' + e.message);
            }
        }

        async function rejectEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;

            const feedback = document.getElementById('feedbackInput').value;
            if (!feedback) {
                if (!confirm("Reject without feedback? The AI won't learn why.")) return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            closeModal();
            const index = pendingEmails.findIndex(e => e.id === emailId);
            if (index > -1) pendingEmails.splice(index, 1);
            renderPendingEmails();

            try {
                const response = await fetch(`/api/emails/${emailId}/reject?token=${token}&reason=${encodeURIComponent(feedback)}`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }
            } catch (e) {
                alert('Error rejecting email: ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function viewConstraintFix() {
            alert('Recommendation: Test new subject lines. Current reply rate (6.5%) is below target (8%).\n\nSuggested fix:\n1. A/B test 3 new subject lines\n2. Review recent negative replies for patterns\n3. Consider softer CTAs for cold lists');
        }

        function snoozeConstraint() {
            document.getElementById('constraintBanner').style.display = 'none';
            showToast('Constraint snoozed for 24 hours');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid var(--border);
                font-size: 14px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        let currentFilter = 'all';

        function classifyPriority(email) {
            const tier = (email.tier || 'tier_3').toLowerCase();
            let employees = 0;

            if (email.employees) {
                const empStr = String(email.employees);
                const parsed = parseInt(empStr.split('-')[0].replace(/,/g, ''));
                employees = isNaN(parsed) ? 0 : parsed;
            }

            if (tier === 'tier_1' && employees >= 50) return 'hot';
            if (tier === 'tier_1' || tier === 'tier_2') return 'warm';
            return 'low';
        }

        function filterEmails(priority) {
            currentFilter = priority;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPendingEmails();
        }

        async function bulkApprove() {
            const lowPriorityEmails = pendingEmails.filter(e => classifyPriority(e) === 'low');

            if (lowPriorityEmails.length === 0) {
                showToast('No low priority emails to approve');
                return;
            }

            if (!confirm(`Approve ${lowPriorityEmails.length} low priority emails?`)) return;

            let approved = 0;
            for (const email of lowPriorityEmails) {
                try {
                    const token = getToken();
                    const response = await fetch(`/api/approve?token=${token}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email_id: email.id })
                    });
                    if (response.ok) approved++;
                } catch (e) {
                    console.error('Bulk approve error:', e);
                }
            }

            showToast(`‚úÖ Approved ${approved} emails`);
            location.reload();
        }

        function getPriorityBadge(email) {
            const priority = classifyPriority(email);
            switch (priority) {
                case 'hot': return '<span class="priority-hot">üî¥ HOT</span>';
                case 'warm': return '<span class="priority-warm">üü° WARM</span>';
                case 'low': return '<span class="priority-low">üü¢ LOW</span>';
                default: return '';
            }
        }

        renderPendingEmails();
        renderActivityFeed();

        setInterval(() => {
            console.log('Auto-refresh...');
        }, 30000);
    </script>
</body>

</html>