<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ChiefAIOfficer - Sales Dashboard v2.4</title>
    <style>
        :root {
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --green: #10b981;
            --green-bg: rgba(16, 185, 129, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* NAV */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .nav-brand img {
            height: 32px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-user .status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--blue-bg);
            color: var(--blue);
        }

        /* MAIN LAYOUT */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* CONSTRAINT BANNER */
        .ramp-banner {
            background: linear-gradient(135deg, var(--blue-bg), transparent);
            border: 1px solid var(--blue);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .ramp-banner.active {
            display: flex;
        }

        .ramp-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .ramp-info .ramp-icon {
            font-size: 24px;
        }

        .ramp-info .ramp-text {
            font-size: 14px;
        }

        .ramp-info .ramp-text strong {
            color: var(--blue);
        }

        .ramp-stats {
            display: flex;
            gap: 24px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .ramp-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ramp-stat .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .ramp-stat .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .constraint-banner {
            background: linear-gradient(135deg, var(--red-bg), transparent);
            border: 1px solid var(--red);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .constraint-banner.success {
            background: linear-gradient(135deg, var(--green-bg), transparent);
            border-color: var(--green);
        }

        .constraint-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .constraint-icon {
            font-size: 32px;
        }

        .constraint-text h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .constraint-text p {
            font-size: 18px;
            font-weight: 600;
        }

        .constraint-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* SCORECARD GRID */
        .scorecard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .scorecard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .scorecard {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .metric-status {
            font-size: 18px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-value.green {
            color: var(--green);
        }

        .metric-value.yellow {
            color: var(--yellow);
        }

        .metric-value.red {
            color: var(--red);
        }

        .metric-target {
            font-size: 12px;
            color: var(--text-muted);
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            margin-top: 8px;
        }

        .metric-trend.up {
            color: var(--green);
        }

        .metric-trend.down {
            color: var(--red);
        }

        /* PENDING APPROVALS SECTION */
        .section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .section-badge {
            background: var(--red);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* PRIORITY BADGES */
        .priority-hot {
            background: var(--red);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-warm {
            background: var(--yellow);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-low {
            background: var(--green);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* SEGMENT FILTERS */
        .filter-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--blue-bg);
            border-color: var(--blue);
            color: var(--blue);
        }

        /* BULK ACTIONS */
        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        /* EMAIL QUEUE */
        .email-list {
            padding: 0;
        }

        .email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .email-item:hover {
            background: var(--bg-hover);
        }

        .email-item:last-child {
            border-bottom: none;
        }

        .email-info {
            flex: 1;
        }

        .email-subject {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .email-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }

        .email-tier {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .email-tier.tier1 {
            background: var(--green-bg);
            color: var(--green);
        }

        .email-tier.tier2 {
            background: var(--blue-bg);
            color: var(--blue);
        }

        .email-tier.tier3 {
            background: var(--yellow-bg);
            color: var(--yellow);
        }

        .route-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
        }

        .route-badge.platform-instantly {
            border-color: rgba(34, 197, 94, 0.5);
            color: #34d399;
            background: rgba(16, 185, 129, 0.1);
        }

        .route-badge.platform-ghl {
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        .route-badge.platform-heyreach {
            border-color: rgba(244, 114, 182, 0.5);
            color: #f472b6;
            background: rgba(244, 114, 182, 0.12);
        }

        .campaign-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 1px 7px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.02);
        }

        .email-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-approve {
            background: var(--green);
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-reject {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--red);
            cursor: pointer;
        }

        .btn-reject:hover {
            background: var(--red-bg);
        }

        .btn-preview {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .btn-preview:hover {
            background: var(--bg-hover);
        }

        /* TWO COLUMN LAYOUT */
        .two-col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* ACTIVITY FEED */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.sent {
            background: var(--green-bg);
        }

        .activity-icon.reply {
            background: var(--blue-bg);
        }

        .activity-icon.meeting {
            background: var(--yellow-bg);
        }

        .activity-text {
            flex: 1;
        }

        .activity-text p {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .activity-text span {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* EMAIL PREVIEW MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-sidebar {
            background: var(--bg-dark);
            border-left: 1px solid var(--border);
            padding-left: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .email-preview-field {
            margin-bottom: 16px;
        }

        .email-preview-field label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .email-preview-field .value {
            font-size: 14px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .email-preview-field .body {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* EMAIL BODY EDIT STYLES - FOR HTML RENDERING FIX */
        .body-edit {
            width: 100%;
            min-height: 200px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .body-edit p {
            margin-bottom: 1em;
        }

        .body-edit ul,
        .body-edit ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .body-edit li {
            margin-bottom: 4px;
        }

        .body-edit a {
            color: var(--blue);
            text-decoration: underline;
            cursor: pointer;
        }

        .body-edit br {
            display: block;
            content: "";
            margin-top: 0.5em;
        }

        .body-edit strong,
        .body-edit b {
            font-weight: 600;
            color: var(--text-primary);
        }

        .body-edit em,
        .body-edit i {
            font-style: italic;
        }

        .body-edit blockquote {
            border-left: 3px solid var(--blue);
            padding-left: 12px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        .body-edit:focus {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        .body-edit img {
            max-width: 100%;
            height: auto;
        }

        .body-edit:empty:before {
            content: "Click to edit email body...";
            color: var(--text-muted);
            font-style: italic;
        }

        .feedback-input {
            width: 100%;
            min-height: 80px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            margin-top: 4px;
        }

        /* SIDEBAR LAYOUT */
        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-field {
            margin-bottom: 12px;
        }

        .sidebar-field label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .sidebar-field .value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .signal-checklist {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 6px;
        }

        .signal-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            width: fit-content;
            border: 1px solid var(--border);
            background: var(--bg-dark);
        }

        .signal-item.pass {
            border-color: rgba(16, 185, 129, 0.45);
            color: var(--green);
        }

        .signal-item.warn {
            border-color: rgba(251, 191, 36, 0.45);
            color: var(--yellow);
        }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="nav-brand">
            <span>üìä</span>
            <span>ChiefAIOfficer Sales Dashboard <small
                    style="font-size:11px; color:#666; margin-left:8px;">v2.4</small></span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('emails')">Email Queue</button>
            <button class="nav-tab" onclick="showTab('campaigns')">Campaigns</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>
        <div class="nav-user">
            <div class="status">
                <span class="dot"></span>
                <span>Swarm Active</span>
            </div>
            <span style="color: var(--text-secondary); font-size: 14px;">Dani Apgar</span>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- RAMP MODE BANNER (fetched from /api/operator/status) -->
        <div class="ramp-banner" id="rampBanner">
            <div class="ramp-info">
                <span class="ramp-icon">üöÄ</span>
                <div class="ramp-text">
                    <strong>RAMP MODE</strong> ‚Äî Supervised go-live in progress.
                    <span id="rampDetail">Loading...</span>
                </div>
            </div>
            <div class="ramp-stats">
                <div class="ramp-stat">
                    <span class="stat-value" id="rampDay">-</span>
                    <span class="stat-label">Day</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampLimit">-</span>
                    <span class="stat-label">Daily Limit</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampTier">-</span>
                    <span class="stat-label">Tier Filter</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampSent">-</span>
                    <span class="stat-label">Sent Today</span>
                </div>
            </div>
        </div>

        <div class="constraint-banner" id="constraintBanner">
            <div class="constraint-left">
                <span class="constraint-icon">‚ö†Ô∏è</span>
                <div class="constraint-text">
                    <h3>Your #1 Constraint</h3>
                    <p id="constraintMessage">Reply Rate below target (6.5% vs 8% target)</p>
                </div>
            </div>
            <div class="constraint-actions">
                <button class="btn btn-primary" onclick="viewConstraintFix()">View Fix</button>
                <button class="btn btn-secondary" onclick="snoozeConstraint()">Snooze 24h</button>
            </div>
        </div>

        <!-- SCORECARD -->
        <div class="scorecard">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Emails Sent</span>
                    <span class="metric-status">üìß</span>
                </div>
                <div class="metric-value green" id="emailsSent">847</div>
                <div class="metric-target">Target: 2,500/mo ‚Ä¢ 34% of limit</div>
                <div class="metric-trend up">‚Üë 12% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Reply Rate</span>
                    <span class="metric-status">üí¨</span>
                </div>
                <div class="metric-value yellow" id="replyRate">6.5%</div>
                <div class="metric-target">Target: 8%</div>
                <div class="metric-trend down">‚Üì 0.8% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Meetings Booked</span>
                    <span class="metric-status">üìÖ</span>
                </div>
                <div class="metric-value green" id="meetingsBooked">12</div>
                <div class="metric-target">Target: 15/mo</div>
                <div class="metric-trend up">‚Üë 3 vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Pipeline Value</span>
                    <span class="metric-status">üí∞</span>
                </div>
                <div class="metric-value green" id="pipelineValue">$142K</div>
                <div class="metric-target">Target: $200K/mo</div>
                <div class="metric-trend up">‚Üë $28K vs last week</div>
            </div>
        </div>

        <div class="two-col">
            <!-- PENDING APPROVALS -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üì• Pending Email Approvals</h2>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterEmails('all')">All</button>
                        <button class="filter-btn" onclick="filterEmails('hot')">üî¥ Hot</button>
                        <button class="filter-btn" onclick="filterEmails('warm')">üü° Warm</button>
                        <button class="filter-btn" onclick="filterEmails('low')">üü¢ Low</button>
                        <span class="section-badge" id="pendingCount">3</span>
                        <div class="bulk-actions">
                            <button class="btn-sm btn-primary" onclick="bulkApprove()">‚úÖ Approve All Low</button>
                        </div>
                    </div>
                </div>
                <div class="email-list" id="emailList">
                    <!-- Email items populated by JS -->
                </div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üîî Recent Activity</h2>
                </div>
                <div id="activityFeed">
                    <!-- Activity items populated by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- EMAIL PREVIEW MODAL -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Email Editor &amp; Preview</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="emailPreviewBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-reject btn-sm" onclick="rejectEmail()">Reject</button>
                <button class="btn btn-approve" onclick="approveEmail()">‚úì Approve &amp; Send</button>
            </div>
        </div>
    </div>

    <!-- Error Reporter for debug-mcp correlation -->
    <script src="/static/error-reporter.js"></script>
    <script>
        const pendingEmails = [];
        const recentActivity = [];
        let lastRefreshAt = null;
        let refreshInFlight = false;
        const REFRESH_INTERVAL_MS = 15000;
        const TOKEN_STORAGE_KEY = `caio_dashboard_token_${window.location.host}`;
        const LEGACY_TOKEN_STORAGE_KEY = 'caio_dashboard_token';

        let tokenPrompted = false;
        let authRequiredForQueue = false;
        let lastPendingFetchError = '';
        let hasSuccessfulQueueFetch = false;

        function persistToken(token) {
            if (!token) return;
            localStorage.setItem(TOKEN_STORAGE_KEY, token);
            localStorage.setItem(LEGACY_TOKEN_STORAGE_KEY, token);
        }

        function clearPersistedToken() {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            localStorage.removeItem(LEGACY_TOKEN_STORAGE_KEY);
        }

        function getToken({ promptFallback = false, forcePrompt = false } = {}) {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromQuery = urlParams.get('token');
            if (tokenFromQuery && tokenFromQuery.trim()) {
                const normalized = tokenFromQuery.trim();
                persistToken(normalized);
                return normalized;
            }

            if (!forcePrompt) {
                const tokenFromStorage = localStorage.getItem(TOKEN_STORAGE_KEY);
                if (tokenFromStorage && tokenFromStorage.trim()) {
                    return tokenFromStorage.trim();
                }
                const tokenFromLegacyStorage = localStorage.getItem(LEGACY_TOKEN_STORAGE_KEY);
                if (tokenFromLegacyStorage && tokenFromLegacyStorage.trim()) {
                    const normalized = tokenFromLegacyStorage.trim();
                    localStorage.setItem(TOKEN_STORAGE_KEY, normalized);
                    return normalized;
                }
            } else {
                clearPersistedToken();
                tokenPrompted = false;
            }

            if (promptFallback && !tokenPrompted) {
                tokenPrompted = true;
                const tokenFromPrompt = window.prompt('Enter dashboard token for protected API access:');
                if (tokenFromPrompt && tokenFromPrompt.trim()) {
                    const normalized = tokenFromPrompt.trim();
                    persistToken(normalized);
                    authRequiredForQueue = false;
                    lastPendingFetchError = '';
                    return normalized;
                }
            }
            return '';
        }

        function promptForDashboardToken() {
            const token = getToken({ promptFallback: true, forcePrompt: true });
            if (token) {
                fetchPendingEmails({ silent: false });
            }
        }

        function buildAuthHeaders(baseHeaders = {}, token = '') {
            const headers = { ...baseHeaders };
            if (token) {
                headers['X-Dashboard-Token'] = token;
            }
            return headers;
        }

        function buildPendingEmailsUrl(token = '') {
            const params = new URLSearchParams();
            if (token) {
                params.set('token', token);
            }
            params.set('_ts', String(Date.now()));
            return `/api/pending-emails?${params.toString()}`;
        }

        function normalizeTierValue(tier = 'tier_3') {
            const value = String(tier || 'tier_3').toLowerCase();
            return value.startsWith('tier_') ? value : `tier_${value.replace(/[^\d]/g, '') || '3'}`;
        }

        function normalizeTierClass(tier = 'tier_3') {
            return normalizeTierValue(tier).replace('_', '');
        }

        function formatTierLabel(tier = 'tier_3') {
            const value = normalizeTierValue(tier);
            const suffix = value.split('_')[1] || '3';
            return `TIER ${suffix}`;
        }

        function formatPlatformBadge(email) {
            const platform = (email.targetPlatform || 'unknown').toLowerCase();
            const direction = (email.direction || 'outbound').toUpperCase();
            const safePlatform = escapeHtml(platform);
            const label = platform === 'unknown' ? `${direction} ¬∑ UNKNOWN` : `${direction} ¬∑ ${platform.toUpperCase()}`;
            return `<span class="route-badge platform-${safePlatform}">${escapeHtml(label)}</span>`;
        }

        function formatCampaignLine(email) {
            const campaignType = escapeHtml(email.campaignType || 'unmapped');
            const campaignId = escapeHtml(email.campaignId || 'none');
            const syncState = escapeHtml(email.syncState || 'unknown');
            return `<span class="campaign-chip">Campaign: ${campaignType} (${campaignId})</span><span class="campaign-chip">Sync: ${syncState}</span>`;
        }

        function escapeHtml(value = '') {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeRegExp(value = '') {
            return String(value).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function decodeHtmlEntities(value = '') {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = String(value || '');
            return textarea.value;
        }

        function extractFirstName(fullName = '') {
            const cleaned = String(fullName || '').trim();
            if (!cleaned) return 'there';
            return cleaned.split(/\s+/)[0];
        }

        function normalizeEmailBody(rawBody = '') {
            let text = String(rawBody || '');
            text = text.replace(/<style[\s\S]*?<\/style>/gi, '');
            text = text.replace(/<script[\s\S]*?<\/script>/gi, '');
            text = text.replace(/<\/p>/gi, '\n\n').replace(/<p[^>]*>/gi, '');
            text = text.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<\/div>/gi, '\n').replace(/<div[^>]*>/gi, '');
            text = text.replace(/<li[^>]*>/gi, '- ').replace(/<\/li>/gi, '\n');
            text = text.replace(/<\/?ul[^>]*>/gi, '').replace(/<\/?ol[^>]*>/gi, '');
            text = text.replace(/<[^>]+>/g, '');
            text = decodeHtmlEntities(text);
            text = text.replace(/\r\n?/g, '\n');
            text = text.replace(/\u00a0/g, ' ');
            text = text.replace(/[ \t]+\n/g, '\n');
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        function formatCopyForApproval(rawBody = '', email = {}) {
            let text = normalizeEmailBody(rawBody);
            const firstName = extractFirstName(email.recipientName || '');
            const company = (email.company && email.company !== 'Unknown Corp') ? email.company : '';
            const industry = (email.industry && email.industry !== 'N/A') ? email.industry : '';
            const title = (email.title && email.title !== 'Unknown Title') ? email.title : '';

            if (!text || /^no body content$/i.test(text)) {
                const signalLine = title && company
                    ? `Given your role as ${title} at ${company}, this felt relevant.`
                    : company
                        ? `Noticed ${company}${industry ? ` in ${industry}` : ''} and wanted to share a practical AI execution path.`
                        : 'Wanted to share a practical AI execution path that has worked for similar teams.';
                return `Hi ${firstName},\n\n${signalLine}\n\nWould it be useful if I send a one-page plan with 2-3 workflows worth piloting first?\n\nBest,\nDani Apgar\nChief AI Officer\nhttps://caio.cx/ai-exec-briefing-call\n\n---\nReply STOP to unsubscribe.`;
            }

            text = text.replace(/^Hi\s+([^\n,]+),\s*/i, 'Hi $1,\n\n');
            text = text.replace(/\.\s+(Usually,|Most teams|We step in|We act as|How we run it:|What that looks like:|If useful,|Worth a brief chat|Open to|Would it be helpful)/g, '.\n\n$1');
            text = text.replace(/\s+(How we run it:|What that looks like:)/g, '\n\n$1');
            text = text.replace(/(How we run it:|What that looks like:)\s*- /g, '$1\n- ');
            text = text.replace(/\s-\s(?=[A-Za-z0-9][^:\n]{2,60}:)/g, '\n- ');
            text = text.replace(/\n-\s*/g, '\n- ');
            text = text.replace(/\s+(Best,|Cheers,|Thanks,)\s+/g, '\n\n$1\n');
            text = text.replace(/\s+---\s+/g, '\n\n---\n');
            text = text.replace(/\s+(Reply STOP to unsubscribe\.)/i, '\n$1');

            if (normalizeTierValue(email.tier || 'tier_3') === 'tier_1') {
                const hasCompany = company && new RegExp(escapeRegExp(company), 'i').test(text);
                const roleAnchor = title.split(',')[0].trim();
                const hasRole = roleAnchor && roleAnchor.length >= 4 && new RegExp(escapeRegExp(roleAnchor), 'i').test(text);
                if (company && (!hasCompany || !hasRole)) {
                    const signalLine = title
                        ? `Given your role as ${title} at ${company}, this felt relevant.`
                        : `Noticed ${company}${industry ? ` in ${industry}` : ''} and wanted to share a practical AI execution path.`;
                    text = text.replace(/^Hi\s+[^\n,]+,\n\n/i, (match) => `${match}${signalLine}\n\n`);
                }
            }

            text = text.replace(/[ \t]+\n/g, '\n');
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        function buildCopySignalChecks(email = {}, bodyText = '') {
            const body = String(bodyText || '');
            const lower = body.toLowerCase();
            const firstName = extractFirstName(email.recipientName || '').toLowerCase();
            const company = String(email.company || '').toLowerCase();
            const title = String(email.title || '').toLowerCase();
            const roleAnchor = title.split(',')[0].trim();

            const checks = [
                {
                    label: 'Personalization (name + company)',
                    pass: !!firstName && lower.includes(firstName) && !!company && lower.includes(company),
                },
                {
                    label: 'Role-aware context',
                    pass: !!roleAnchor && roleAnchor.length >= 4 && lower.includes(roleAnchor),
                },
                {
                    label: 'Business outcome signal',
                    pass: /(roi|kpi|pipeline|conversion|time saved|productivity|revenue|velocity|meetings)/i.test(body),
                },
                {
                    label: 'Clear CTA',
                    pass: /(\?|15\s*-?\s*minute|quick call|open to|if useful|worth a brief chat)/i.test(body),
                },
                {
                    label: 'Compliance footer',
                    pass: /reply stop to unsubscribe\./i.test(body),
                },
            ];
            return checks;
        }

        function renderSignalChecklist(checks = []) {
            return checks.map((item) => {
                const cls = item.pass ? 'pass' : 'warn';
                const icon = item.pass ? '‚úì' : '‚ö†';
                return `<span class="signal-item ${cls}">${icon} ${escapeHtml(item.label)}</span>`;
            }).join('');
        }

        async function fetchPendingEmails({ silent = false } = {}) {
            if (refreshInFlight) return;
            refreshInFlight = true;
            try {
                let token = getToken({ promptFallback: !silent });
                let response = await fetch(buildPendingEmailsUrl(token), {
                    method: 'GET',
                    cache: 'no-store',
                    headers: buildAuthHeaders({ 'Accept': 'application/json' }, token)
                });

                if (response.status === 401) {
                    authRequiredForQueue = true;
                    lastPendingFetchError = 'Dashboard token missing or invalid. Open /sales?token=<DASHBOARD_AUTH_TOKEN> or click Re-enter Token.';
                    clearPersistedToken();
                }

                if (response.status === 401 && !silent) {
                    token = getToken({ promptFallback: true, forcePrompt: true });
                    response = await fetch(buildPendingEmailsUrl(token), {
                        method: 'GET',
                        cache: 'no-store',
                        headers: buildAuthHeaders({ 'Accept': 'application/json' }, token)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                authRequiredForQueue = false;
                lastPendingFetchError = '';
                hasSuccessfulQueueFetch = true;
                const data = await response.json();
                pendingEmails.length = 0;

                const emails = Array.isArray(data.pending_emails) ? data.pending_emails : [];
                emails.forEach(e => {
                    const recipientEmail = e.to || 'unknown@example.com';
                    const classifier = e.classifier || {};
                    const campaignRef = e.campaign_ref || {};
                    const tier = normalizeTierValue(e.tier || 'tier_3');
                    const queuedEmail = {
                        id: e.email_id,
                        tier,
                        tierClass: normalizeTierClass(tier),
                        tierLabel: formatTierLabel(tier),
                        subject: e.subject || 'No Subject',
                        recipient: recipientEmail,
                        recipientName: e.recipient_data?.name || recipientEmail.split('@')[0],
                        company: e.recipient_data?.company || 'Unknown Corp',
                        title: e.recipient_data?.title || 'Unknown Title',
                        location: e.recipient_data?.location || 'Unknown Location',
                        employees: e.recipient_data?.employees || 'N/A',
                        industry: e.recipient_data?.industry || 'N/A',
                        angle: e.angle || 'General',
                        timestamp: 'Just now',
                        body: e.body || 'No Body Content',
                        direction: classifier.message_direction || e.direction || 'outbound',
                        queueOrigin: classifier.queue_origin || e.source || 'unknown',
                        targetPlatform: classifier.target_platform || e.delivery_platform || 'unknown',
                        targetPlatformReason: classifier.target_platform_reason || 'unknown',
                        routingTargets: Array.isArray(classifier.routing_targets) ? classifier.routing_targets : [],
                        syncState: classifier.sync_state || 'unknown',
                        leadSourceClass: classifier.lead_source_class || 'unknown',
                        campaignId: campaignRef.internal_id || e.context?.campaign_id || 'none',
                        campaignType: campaignRef.internal_type || e.context?.campaign_type || 'unmapped',
                        campaignName: campaignRef.internal_name || e.context?.campaign_name || '',
                        pipelineRunId: campaignRef.pipeline_run_id || e.context?.pipeline_run_id || '',
                        externalProvider: campaignRef.external_provider || '',
                        externalCampaignId: campaignRef.external_campaign_id || '',
                        externalCampaignName: campaignRef.external_campaign_name || ''
                    };
                    queuedEmail.body = formatCopyForApproval(queuedEmail.body, queuedEmail);
                    queuedEmail.copySignals = buildCopySignalChecks(queuedEmail, queuedEmail.body);
                    pendingEmails.push(queuedEmail);
                });

                lastRefreshAt = data.refreshed_at || new Date().toISOString();
                renderPendingEmails();

                if (!silent) {
                    const synced = data.synced_from_gatekeeper || 0;
                    if (synced > 0) {
                        showToast(`Synced ${synced} queued emails into dashboard inbox`);
                    }
                }
            } catch (e) {
                console.error("Failed to fetch pending emails:", e);
                if (!authRequiredForQueue) {
                    lastPendingFetchError = e.message || 'Unknown refresh error';
                }
                renderPendingEmails();
                if (!silent) {
                    showToast(`Refresh failed: ${e.message}`);
                }
            } finally {
                refreshInFlight = false;
            }
        }

        function startAutoRefresh() {
            fetchPendingEmails({ silent: false });
            setInterval(() => {
                fetchPendingEmails({ silent: true });
            }, REFRESH_INTERVAL_MS);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    fetchPendingEmails({ silent: authRequiredForQueue ? false : true });
                }
            });
        }

        function renderPendingEmails() {
            const list = document.getElementById('emailList');

            if (authRequiredForQueue) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîí</div>
                        <h3>Authentication Required</h3>
                        <p>${lastPendingFetchError || 'Dashboard token is required to load pending approvals.'}</p>
                        <div style="margin-top: 12px;">
                            <button class="btn-sm btn-secondary" onclick="promptForDashboardToken()">Re-enter Token</button>
                        </div>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '!';
                return;
            }

            if (!hasSuccessfulQueueFetch && lastPendingFetchError) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Queue Unavailable</h3>
                        <p>${lastPendingFetchError}</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '?';
                return;
            }

            const filteredEmails = currentFilter === 'all'
                ? pendingEmails
                : pendingEmails.filter(e => classifyPriority(e) === currentFilter);

            if (filteredEmails.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <h3>All caught up!</h3>
                        <p>No pending emails to review</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '0';
                return;
            }

            document.getElementById('pendingCount').textContent = filteredEmails.length;

            list.innerHTML = filteredEmails.map(email => {
                const safeId = escapeHtml(email.id);
                const safeTierClass = escapeHtml(email.tierClass);
                const safeTierLabel = escapeHtml(email.tierLabel);
                const safeSubject = escapeHtml(email.subject);
                const safeRecipientName = escapeHtml(email.recipientName);
                const safeCompany = escapeHtml(email.company);
                const safeAngle = escapeHtml(email.angle);
                const safeTimestamp = escapeHtml(email.timestamp);
                const safeQueueOrigin = escapeHtml(email.queueOrigin);
                return `
                <div class="email-item">
                    <div class="email-info">
                        <div class="email-subject">
                            ${getPriorityBadge(email)}
                            <span class="email-tier ${safeTierClass}">${safeTierLabel}</span>
                            ${formatPlatformBadge(email)}
                            ${safeSubject}
                        </div>
                        <div class="email-meta">
                            <span>To: ${safeRecipientName} (${safeCompany})</span>
                            <span>Angle: ${safeAngle}</span>
                            <span>${safeTimestamp}</span>
                        </div>
                        <div class="email-meta" style="margin-top: 6px;">
                            <span>${formatCampaignLine(email)}</span>
                            <span>Origin: ${safeQueueOrigin}</span>
                        </div>
                    </div>
                    <div class="email-actions">
                        <button class="btn-sm btn-preview" onclick="previewEmail('${safeId}')">Edit & Preview</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderActivityFeed() {
            const feed = document.getElementById('activityFeed');
            if (recentActivity.length === 0) {
                feed.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon sent">üìß</div>
                        <div class="activity-text">
                            <p>Swarm is running. Waiting for activity...</p>
                            <span id="activityModeLabel">Live Mode</span>
                        </div>
                    </div>
                `;
                return;
            }

            feed.innerHTML = recentActivity.map(act => `
                <div class="activity-item">
                    <div class="activity-icon ${act.type}">${act.icon}</div>
                    <div class="activity-text">
                        <p>${act.message}</p>
                        <span>${act.time}</span>
                    </div>
                </div>
            `).join('');
        }

        let currentEmailId = null;

        function previewEmail(emailId) {
            currentEmailId = emailId;
            const email = pendingEmails.find(e => e.id === emailId);
            if (!email) return;

            const recipientName = escapeHtml(email.recipientName);
            const recipient = escapeHtml(email.recipient);
            const subject = escapeHtml(email.subject);
            const title = escapeHtml(email.title);
            const company = escapeHtml(email.company);
            const employees = escapeHtml(email.employees);
            const location = escapeHtml(email.location);
            const angle = escapeHtml(email.angle);
            const tierClass = escapeHtml(email.tierClass);
            const tierLabel = escapeHtml(email.tierLabel);
            const direction = escapeHtml((email.direction || 'outbound').toUpperCase());
            const targetPlatform = escapeHtml((email.targetPlatform || 'unknown').toUpperCase());
            const campaignType = escapeHtml(email.campaignType || 'unmapped');
            const campaignId = escapeHtml(email.campaignId || 'none');
            const syncState = escapeHtml(email.syncState || 'unknown');
            const queueOrigin = escapeHtml(email.queueOrigin || 'unknown');
            const leadSourceClass = escapeHtml(email.leadSourceClass || 'unknown');
            const routingTargets = escapeHtml((email.routingTargets || []).join(', ') || 'none');
            const checksHtml = renderSignalChecklist(email.copySignals || []);

            document.getElementById('emailPreviewBody').innerHTML = `
                <div class="modal-main">
                    <!-- TO -->
                    <div class="email-preview-field">
                        <label>To</label>
                        <div class="value">${recipientName} &lt;${recipient}&gt;</div>
                    </div>
                    <!-- SUBJECT -->
                    <div class="email-preview-field">
                        <label>Subject</label>
                        <div class="value">${subject}</div>
                    </div>
                    <!-- EDITABLE BODY -->
                    <div class="email-preview-field">
                        <label>Email Body (Click to Edit)</label>
                        <div id="emailBodyInput" class="body-edit" contenteditable="true"></div>
                    </div>
                    <!-- FEEDBACK -->
                    <div class="email-preview-field">
                        <label>Feedback for AI (Help the Agents Learn)</label>
                        <textarea id="feedbackInput" class="feedback-input" placeholder="e.g. 'Good angle, but make the intro shorter next time' or 'This person is not a decision maker'"></textarea>
                    </div>
                </div>
                <div class="modal-sidebar">
                    <div class="sidebar-title">Lead Insights</div>
                    <div class="sidebar-field">
                        <label>Target</label>
                        <div class="value">${recipientName}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Title</label>
                        <div class="value">${title}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Company</label>
                        <div class="value">${company}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Employees</label>
                        <div class="value">${employees}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Location</label>
                        <div class="value">${location}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Angle Used</label>
                        <div class="value"><span class="email-tier ${tierClass}">${tierLabel}</span> ${angle}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Delivery Classifier</label>
                        <div class="value">${direction} ‚Üí ${targetPlatform}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Campaign Mapping</label>
                        <div class="value">${campaignType} (${campaignId})</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Sync State</label>
                        <div class="value">${syncState}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Queue Origin</label>
                        <div class="value">${queueOrigin} (${leadSourceClass})</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Routing Targets</label>
                        <div class="value">${routingTargets}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Tier 1 Copy Signals</label>
                        <div class="signal-checklist">${checksHtml}</div>
                    </div>

                    <div class="sidebar-title" style="margin-top: 24px;">Actions</div>
                    <button class="btn-sm btn-secondary" style="width:100%">üîó View LinkedIn</button>
                    <button class="btn-sm btn-secondary" style="width:100%; margin-top:8px;">üè¢ View Website</button>
                </div>
            `;

            const bodyInput = document.getElementById('emailBodyInput');
            if (bodyInput) {
                bodyInput.textContent = email.body || 'No Body Content';
            }

            document.getElementById('emailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('emailModal').classList.remove('active');
            currentEmailId = null;
        }

        async function approveEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;
            const token = getToken({ promptFallback: true });
            const email = pendingEmails.find(e => e.id === emailId) || {};
            const rawEditedBody = (document.getElementById('emailBodyInput')?.innerText || '').trim();
            const editedBody = formatCopyForApproval(rawEditedBody, email);
            const feedback = document.getElementById('feedbackInput').value;

            try {
                const query = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/emails/${emailId}/approve${query}`, {
                    method: 'POST',
                    headers: buildAuthHeaders({ 'Content-Type': 'application/json' }, token),
                    body: JSON.stringify({
                        edited_body: editedBody,
                        feedback: feedback
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                closeModal();
                await fetchPendingEmails({ silent: true });
                showToast('Email approved');
            } catch (e) {
                alert('Error approving email: ' + e.message);
            }
        }

        async function rejectEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;
            const feedback = document.getElementById('feedbackInput').value;
            if (!feedback) {
                if (!confirm("Reject without feedback? The AI won't learn why.")) return;
            }

            const token = getToken({ promptFallback: true });

            try {
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('reason', feedback);

                const response = await fetch(`/api/emails/${emailId}/reject?${params.toString()}`, {
                    method: 'POST',
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                closeModal();
                await fetchPendingEmails({ silent: true });
                showToast('Email rejected');
            } catch (e) {
                alert('Error rejecting email: ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function viewConstraintFix() {
            alert('Recommendation: Test new subject lines. Current reply rate (6.5%) is below target (8%).\n\nSuggested fix:\n1. A/B test 3 new subject lines\n2. Review recent negative replies for patterns\n3. Consider softer CTAs for cold lists');
        }

        function snoozeConstraint() {
            document.getElementById('constraintBanner').style.display = 'none';
            showToast('Constraint snoozed for 24 hours');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid var(--border);
                font-size: 14px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        let currentFilter = 'all';

        function classifyPriority(email) {
            const tier = (email.tier || 'tier_3').toLowerCase();
            let employees = 0;

            if (email.employees) {
                const empStr = String(email.employees);
                const parsed = parseInt(empStr.split('-')[0].replace(/,/g, ''));
                employees = isNaN(parsed) ? 0 : parsed;
            }

            if (tier === 'tier_1' && employees >= 50) return 'hot';
            if (tier === 'tier_1' || tier === 'tier_2') return 'warm';
            return 'low';
        }

        function filterEmails(priority) {
            currentFilter = priority;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPendingEmails();
        }

        async function bulkApprove() {
            const lowPriorityEmails = pendingEmails.filter(e => classifyPriority(e) === 'low');

            if (lowPriorityEmails.length === 0) {
                showToast('No low priority emails to approve');
                return;
            }

            if (!confirm(`Approve ${lowPriorityEmails.length} low priority emails?`)) return;

            let approved = 0;
            const token = getToken({ promptFallback: true });
            for (const email of lowPriorityEmails) {
                try {
                    const query = token ? `?token=${encodeURIComponent(token)}` : '';
                    const response = await fetch(`/api/emails/${email.id}/approve${query}`, {
                        method: 'POST',
                        headers: buildAuthHeaders({ 'Content-Type': 'application/json' }, token),
                        body: JSON.stringify({ feedback: 'bulk_approved_low_priority' })
                    });
                    if (response.ok) approved++;
                } catch (e) {
                    console.error('Bulk approve error:', e);
                }
            }

            showToast(`‚úÖ Approved ${approved} emails`);
            await fetchPendingEmails({ silent: true });
        }

        function getPriorityBadge(email) {
            const priority = classifyPriority(email);
            switch (priority) {
                case 'hot': return '<span class="priority-hot">üî¥ HOT</span>';
                case 'warm': return '<span class="priority-warm">üü° WARM</span>';
                case 'low': return '<span class="priority-low">üü¢ LOW</span>';
                default: return '';
            }
        }

        async function fetchOperatorStatus() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                const response = await fetch(`/api/operator/status?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();

                const ramp = data.ramp || {};
                const banner = document.getElementById('rampBanner');

                if (ramp.active) {
                    banner.classList.add('active');
                    const dayText = ramp.day || 0;
                    const totalDays = ramp.remaining_days ? (dayText + ramp.remaining_days - 1) : 3;
                    document.getElementById('rampDay').textContent = `${dayText}/${totalDays}`;
                    document.getElementById('rampLimit').textContent = ramp.email_limit_override || '-';
                    document.getElementById('rampTier').textContent = (ramp.tier_filter || 'all').toUpperCase().replace('_', ' ');
                    document.getElementById('rampDetail').textContent =
                        `Day ${dayText} of ${totalDays} supervised days. Only ${(ramp.tier_filter || 'all').toUpperCase().replace('_', ' ')} leads at ${ramp.email_limit_override || '?'}/day.`;

                    // Update sent today from warmup schedule
                    const emailSchedule = data.warmup_schedule?.email || {};
                    const used = emailSchedule.used_today || 0;
                    const limit = emailSchedule.daily_limit || ramp.email_limit_override || 5;
                    document.getElementById('rampSent').textContent = `${used}/${limit}`;
                } else if (ramp.enabled === false) {
                    banner.classList.remove('active');
                }
            } catch (e) {
                console.warn('Failed to fetch operator status:', e);
            }
        }

        renderPendingEmails();
        renderActivityFeed();
        fetchOperatorStatus();
        startAutoRefresh();
        // Refresh operator status every 30s
        setInterval(fetchOperatorStatus, 30000);
    </script>
</body>

</html>
