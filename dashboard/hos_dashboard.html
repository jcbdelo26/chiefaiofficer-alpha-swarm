<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ChiefAIOfficer - Sales Dashboard v2.2</title>
    <style>
        :root {
            /* ... existing vars ... */
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --green: #10b981;
            --green-bg: rgba(16, 185, 129, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
        }

        /* ... existing styles ... */

        /* ENHANCED EMAIL BODY STYLES */
        .body-edit {
            width: 100%;
            min-height: 200px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
            overflow-y: auto;
        }

        .body-edit p {
            margin-bottom: 1em;
        }

        .body-edit ul,
        .body-edit ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .body-edit li {
            margin-bottom: 4px;
        }

        .body-edit a {
            color: var(--blue);
            text-decoration: underline;
            cursor: pointer;
        }

        /* Additional HTML rendering fixes */
        .body-edit br {
            display: block;
            content: "";
            margin-top: 0.5em;
        }

        .body-edit strong, .body-edit b {
            font-weight: 600;
            color: var(--text-primary);
        }

        .body-edit em, .body-edit i {
            font-style: italic;
        }

        .body-edit blockquote {
            border-left: 3px solid var(--blue);
            padding-left: 12px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        /* Ensure focus state is visible for editing */
        .body-edit:focus {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        /* Email signature styling */
        .body-edit .signature,
        .body-edit [style*="font-size: small"],
        .body-edit [style*="color: gray"] {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* Prevent content overflow */
        .body-edit img {
            max-width: 100%;
            height: auto;
        }

        /* Placeholder text when empty */
        .body-edit:empty:before {
            content: "Click to edit email body...";
            color: var(--text-muted);
            font-style: italic;
        }

    </style>
</head>

<body>
    <!-- (Navigation and Main Content skipped for brevity, keeping same) -->
    <!-- ... -->
    <nav class="nav">
        <div class="nav-brand">
            <span>üìä</span>
            <span>ChiefAIOfficer Sales Dashboard <small
                    style="font-size:11px; color:#666; margin-left:8px;">v2.2</small></span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('emails')">Email Queue</button>
            <button class="nav-tab" onclick="showTab('campaigns')">Campaigns</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>
        <div class="nav-user">
            <div class="status">
                <span class="dot"></span>
                <span>Swarm Active</span>
            </div>
            <span style="color: var(--text-secondary); font-size: 14px;">Dani Apgar</span>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- (Constraint Banner and Scorecard skipped) -->
        <div class="constraint-banner" id="constraintBanner">
            <div class="constraint-left">
                <span class="constraint-icon">‚ö†Ô∏è</span>
                <div class="constraint-text">
                    <h3>Your #1 Constraint</h3>
                    <p id="constraintMessage">Reply Rate below target (6.5% vs 8% target)</p>
                </div>
            </div>
            <div class="constraint-actions">
                <button class="btn btn-primary" onclick="viewConstraintFix()">View Fix</button>
                <button class="btn btn-secondary" onclick="snoozeConstraint()">Snooze 24h</button>
            </div>
        </div>

        <!-- SCORECARD -->
        <div class="scorecard">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Emails Sent</span>
                    <span class="metric-status">üìß</span>
                </div>
                <div class="metric-value green" id="emailsSent">847</div>
                <div class="metric-target">Target: 2,500/mo ‚Ä¢ 34% of limit</div>
                <div class="metric-trend up">‚Üë 12% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Reply Rate</span>
                    <span class="metric-status">üí¨</span>
                </div>
                <div class="metric-value yellow" id="replyRate">6.5%</div>
                <div class="metric-target">Target: 8%</div>
                <div class="metric-trend down">‚Üì 0.8% vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Meetings Booked</span>
                    <span class="metric-status">üìÖ</span>
                </div>
                <div class="metric-value green" id="meetingsBooked">12</div>
                <div class="metric-target">Target: 15/mo</div>
                <div class="metric-trend up">‚Üë 3 vs last week</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Pipeline Value</span>
                    <span class="metric-status">üí∞</span>
                </div>
                <div class="metric-value green" id="pipelineValue">$142K</div>
                <div class="metric-target">Target: $200K/mo</div>
                <div class="metric-trend up">‚Üë $28K vs last week</div>
            </div>
        </div>

        <div class="two-col">
            <!-- PENDING APPROVALS -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üì• Pending Email Approvals</h2>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterEmails('all')">All</button>
                        <button class="filter-btn" onclick="filterEmails('hot')">üî¥ Hot</button>
                        <button class="filter-btn" onclick="filterEmails('warm')">üü° Warm</button>
                        <button class="filter-btn" onclick="filterEmails('low')">üü¢ Low</button>
                        <span class="section-badge" id="pendingCount">3</span>
                        <div class="bulk-actions">
                            <button class="btn-sm btn-primary" onclick="bulkApprove()">‚úÖ Approve All Low</button>
                        </div>
                    </div>
                </div>
                <div class="email-list" id="emailList">
                    <!-- Email items populated by JS -->
                </div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üîî Recent Activity</h2>
                </div>
                <div id="activityFeed">
                    <!-- Activity items populated by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- EMAIL PREVIEW MODAL -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Email Editor & Preview</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="emailPreviewBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-reject btn-sm" onclick="rejectEmail()">Reject</button>
                <button class="btn btn-approve" onclick="approveEmail()">‚úì Approve & Send</button>
            </div>
        </div>
    </div>

    <script>
        // ... (Mock Data skipped, fetch functions needed in real version) ...
        const pendingEmails = []; // Will be fetched from API in real usage
        const recentActivity = [];

        async function fetchPendingEmails() {
            try {
                // Get token from URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                const response = await fetch(`/api/pending-emails?auth_token=${token}&token=${token}`);
                if (response.ok) {
                    const data = await response.json();
                    // Update mock array with real data if available
                    if (data.pending_emails && data.pending_emails.length > 0) {
                        // Clear mock data
                        pendingEmails.length = 0;
                        data.pending_emails.forEach(e => {
                            pendingEmails.push({
                                id: e.email_id,
                                tier: e.tier || 'tier1',
                                tierLabel: (e.tier || 'Tier 1').toUpperCase(),
                                subject: e.subject,
                                recipient: e.to,
                                recipientName: e.recipient_data?.name || e.to.split('@')[0],
                                company: e.recipient_data?.company || 'Unknown Corp',
                                title: e.recipient_data?.title || 'Unknown Title',
                                location: e.recipient_data?.location || 'Unknown Location',
                                employees: e.recipient_data?.employees || 'N/A',
                                industry: e.recipient_data?.industry || 'N/A',
                                angle: e.angle || 'General',
                                timestamp: 'Just now',
                                body: e.body
                            });
                        });
                        renderPendingEmails();
                    }
                }
            } catch (e) {
                console.error("Failed to fetch pending emails:", e);
            }
        }

        // Call fetch on load
        document.addEventListener('DOMContentLoaded', fetchPendingEmails);

        // RENDER FUNCTIONS (Same as before)
        function renderPendingEmails() {
            const container = document.getElementById('emailList');

            if (pendingEmails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <h3>All caught up!</h3>
                        <p>No emails pending approval.</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '0';
                return;
            }

            document.getElementById('pendingCount').textContent = pendingEmails.length;

            container.innerHTML = pendingEmails.map(email => `
                <div class="email-item" data-id="${email.id}">
                    <div class="email-info">
                        <div class="email-subject">
                            <span class="email-tier ${email.tier}">${email.tierLabel}</span>
                            ${email.subject}
                        </div>
                        <div class="email-meta">
                            <span>To: ${email.recipientName} (${email.company})</span>
                            <span>Angle: ${email.angle}</span>
                            <span>${email.timestamp}</span>
                        </div>
                    </div>
                    <div class="email-actions">
                        <button class="btn-sm btn-preview" onclick="previewEmail('${email.id}')">Edit & Preview</button>
                    </div>
                </div>
            `).join('');
        }

        function renderActivityFeed() {
            // (Same as before)
            const container = document.getElementById('activityFeed');
            container.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon info">‚ÑπÔ∏è</div>
                    <div class="activity-text"><p>System in Live Mode (Limit 25/day)</p><span>Now</span></div>
                </div>
            `;
        }

        // Initial render
        renderActivityFeed();

        // =====================================================================
        // EMAIL APPROVAL FUNCTIONS (UPDATED v2.2)
        // =====================================================================

        /**
         * Sanitize HTML to prevent XSS while allowing safe formatting tags.
         * Allows: p, br, strong, b, em, i, ul, ol, li, a (with href), blockquote
         */
        function sanitizeEmailHtml(html) {
            if (!html) return '';
            
            // Create a temporary element to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Remove script tags and event handlers
            const scripts = temp.querySelectorAll('script, style, iframe, object, embed');
            scripts.forEach(el => el.remove());
            
            // Remove event handlers from all elements
            const allElements = temp.querySelectorAll('*');
            allElements.forEach(el => {
                // Remove event handlers
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    }
                });
                // Sanitize href to prevent javascript: URLs
                if (el.hasAttribute('href')) {
                    const href = el.getAttribute('href');
                    if (href && href.toLowerCase().startsWith('javascript:')) {
                        el.setAttribute('href', '#');
                    }
                }
            });
            
            return temp.innerHTML;
        }

        /**
         * Convert plain text with newlines to HTML paragraphs.
         */
        function textToHtml(text) {
            if (!text) return '';
            // If already contains HTML tags, just sanitize
            if (/<[a-z][\s\S]*>/i.test(text)) {
                return sanitizeEmailHtml(text);
            }
            // Convert plain text to paragraphs
            return text.split(/\n\n+/).map(para => 
                `<p>${para.replace(/\n/g, '<br>')}</p>`
            ).join('');
        }

        function previewEmail(emailId) {
            const email = pendingEmails.find(e => e.id === emailId);
            if (!email) return;

            currentEmailId = emailId;

            document.getElementById('emailPreviewBody').innerHTML = `
                <!-- MAIN CONTENT (LEFT) -->
                <div class="modal-main">
                    <div class="email-preview-field">
                        <label>To</label>
                        <div class="value">${email.recipientName} &lt;${email.recipient}&gt;</div>
                    </div>
                    <div class="email-preview-field">
                        <label>Subject</label>
                        <div class="value">${email.subject}</div>
                    </div>
                    
                    <!-- EDITABLE BODY -->
                    <div class="email-preview-field">
                        <label>Email Body (Click to Edit)</label>
                        <div id="emailBodyInput" class="body-edit" contenteditable="true" style="overflow-y: auto;">${textToHtml(email.body)}</div>
                    </div>

                    <!-- FEEDBACK FIELD -->
                    <div class="email-preview-field">
                        <label>Feedback for AI (Help the agents learn)</label>
                        <textarea id="feedbackInput" class="feedback-input" placeholder="e.g. 'Good angle, but make the intro shorter next time' or 'This person is not a decision maker'"></textarea>
                    </div>
                </div>

                <!-- SIDEBAR (RIGHT) -->
                <div class="modal-sidebar">
                    <div class="sidebar-title">Lead Insights</div>
                    
                    <div class="sidebar-field">
                        <label>Target</label>
                        <div class="value">${email.recipientName}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Title</label>
                        <div class="value">${email.title}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Company</label>
                        <div class="value">${email.company}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Employees</label>
                        <div class="value">${email.employees}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Location</label>
                        <div class="value">${email.location}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Angle Used</label>
                        <div class="value"><span class="email-tier ${email.tier}">${email.tierLabel}</span> ${email.angle}</div>
                    </div>

                    <div class="sidebar-title" style="margin-top: 24px;">Actions</div>
                    <button class="btn-sm btn-secondary" style="width:100%">üîó View LinkedIn</button>
                    <button class="btn-sm btn-secondary" style="width:100%; margin-top:8px;">üè¢ View Website</button>
                </div>
            `;

            document.getElementById('emailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('emailModal').classList.remove('active');
            currentEmailId = null;
        }

        async function approveEmail() {
            if (!currentEmailId) return;

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const editedBody = document.getElementById('emailBodyInput').innerHTML;
            const feedback = document.getElementById('feedbackInput').value;

            // Optimistic update
            closeModal();
            const index = pendingEmails.findIndex(e => e.id === currentEmailId);
            if (index > -1) pendingEmails.splice(index, 1);
            renderPendingEmails();

            try {
                const response = await fetch(`/api/emails/${currentEmailId}/approve?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        edited_body: editedBody,
                        feedback: feedback
                    })
                });

                if (!response.ok) throw new Error('API Error');
                // showToast('‚úì Email approved'); // Toast function not defined in snippet, rely on UI update
            } catch (e) {
                alert('Error approving email: ' + e.message);
                // Revert optimistic update? For simplicity, we just alert.
            }
        }

        async function rejectEmail() {
            if (!currentEmailId) return;

            const feedback = document.getElementById('feedbackInput').value;
            if (!feedback) {
                if (!confirm("Reject without feedback? The AI won't learn why.")) return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            closeModal();
            const index = pendingEmails.findIndex(e => e.id === currentEmailId);
            if (index > -1) pendingEmails.splice(index, 1);
            renderPendingEmails();

            try {
                // Send feedback as 'reason' query param
                const response = await fetch(`/api/emails/${currentEmailId}/reject?token=${token}&reason=${encodeURIComponent(feedback)}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('API Error');
            } catch (e) {
                alert('Error rejecting email: ' + e.message);
            }
        }

        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // TODO: Implement tab switching
        }

        function viewConstraintFix() {
            alert('Recommendation: Test new subject lines. Current reply rate (6.5%) is below target (8%).\n\nSuggested fix:\n1. A/B test 3 new subject lines\n2. Review recent negative replies for patterns\n3. Consider softer CTAs for cold lists');
        }

        function snoozeConstraint() {
            document.getElementById('constraintBanner').style.display = 'none';
            showToast('Constraint snoozed for 24 hours');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid var(--border);
                font-size: 14px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =====================================================================
        // FILTER AND BULK ACTIONS
        // =====================================================================

        let currentFilter = 'all';

        function classifyPriority(email) {
            // Mirror the backend classification logic
            const tier = (email.tier || 'tier_3').toLowerCase();
            let employees = 0;

            if (email.employees) {
                const empStr = String(email.employees);
                const parsed = parseInt(empStr.split('-')[0].replace(/,/g, ''));
                employees = isNaN(parsed) ? 0 : parsed;
            }

            if (tier === 'tier_1' && employees >= 50) return 'hot';
            if (tier === 'tier_1' || tier === 'tier_2') return 'warm';
            return 'low';
        }

        function filterEmails(priority) {
            currentFilter = priority;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Filter and re-render
            renderPendingEmails();
        }

        async function bulkApprove() {
            const lowPriorityEmails = pendingEmails.filter(e => classifyPriority(e) === 'low');

            if (lowPriorityEmails.length === 0) {
                showToast('No low priority emails to approve');
                return;
            }

            if (!confirm(`Approve ${lowPriorityEmails.length} low priority emails?`)) return;

            let approved = 0;
            for (const email of lowPriorityEmails) {
                try {
                    const token = getToken();
                    const response = await fetch(`/api/approve?token=${token}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email_id: email.id })
                    });
                    if (response.ok) approved++;
                } catch (e) {
                    console.error('Bulk approve error:', e);
                }
            }

            showToast(`‚úÖ Approved ${approved} emails`);
            location.reload();
        }

        function getPriorityBadge(email) {
            const priority = classifyPriority(email);
            switch (priority) {
                case 'hot': return '<span class="priority-hot">üî¥ HOT</span>';
                case 'warm': return '<span class="priority-warm">üü° WARM</span>';
                case 'low': return '<span class="priority-low">üü¢ LOW</span>';
                default: return '';
            }
        }

        // =====================================================================
        // INIT
        // =====================================================================

        renderPendingEmails();
        renderActivityFeed();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            // TODO: Fetch from API
            console.log('Auto-refresh...');
        }, 30000);
    </script>
</body>

</html>