<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ChiefAIOfficer - Sales Dashboard v3.0</title>
    <style>
        :root {
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --green: #10b981;
            --green-bg: rgba(16, 185, 129, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* NAV */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .nav-brand img {
            height: 32px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-user .status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--blue-bg);
            color: var(--blue);
        }

        /* MAIN LAYOUT */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* CONSTRAINT BANNER */
        .ramp-banner {
            background: linear-gradient(135deg, var(--blue-bg), transparent);
            border: 1px solid var(--blue);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .ramp-banner.active {
            display: flex;
        }

        .ramp-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .ramp-info .ramp-icon {
            font-size: 24px;
        }

        .ramp-info .ramp-text {
            font-size: 14px;
        }

        .ramp-info .ramp-text strong {
            color: var(--blue);
        }

        .ramp-stats {
            display: flex;
            gap: 24px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .ramp-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ramp-stat .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .ramp-stat .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .constraint-banner {
            background: linear-gradient(135deg, var(--red-bg), transparent);
            border: 1px solid var(--red);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .constraint-banner.success {
            background: linear-gradient(135deg, var(--green-bg), transparent);
            border-color: var(--green);
        }

        .constraint-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .constraint-icon {
            font-size: 32px;
        }

        .constraint-text h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .constraint-text p {
            font-size: 18px;
            font-weight: 600;
        }

        .constraint-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* SCORECARD GRID */
        .scorecard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .scorecard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .scorecard {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .metric-status {
            font-size: 18px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-value.green {
            color: var(--green);
        }

        .metric-value.yellow {
            color: var(--yellow);
        }

        .metric-value.red {
            color: var(--red);
        }

        .metric-target {
            font-size: 12px;
            color: var(--text-muted);
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            margin-top: 8px;
        }

        .metric-trend.up {
            color: var(--green);
        }

        .metric-trend.down {
            color: var(--red);
        }

        /* PENDING APPROVALS SECTION */
        .section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .section-badge {
            background: var(--red);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* PRIORITY BADGES */
        .priority-hot {
            background: var(--red);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-warm {
            background: var(--yellow);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-low {
            background: var(--green);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* SEGMENT FILTERS */
        .filter-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--blue-bg);
            border-color: var(--blue);
            color: var(--blue);
        }

        /* BULK ACTIONS */
        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        /* EMAIL QUEUE */
        .email-list {
            padding: 0;
        }

        .email-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .email-item:hover {
            background: var(--bg-hover);
        }

        .email-item:last-child {
            border-bottom: none;
        }

        .email-info {
            flex: 1;
        }

        .email-subject {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .email-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }

        .email-tier {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .email-tier.tier1 {
            background: var(--green-bg);
            color: var(--green);
        }

        .email-tier.tier2 {
            background: var(--blue-bg);
            color: var(--blue);
        }

        .email-tier.tier3 {
            background: var(--yellow-bg);
            color: var(--yellow);
        }

        .route-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
        }

        .route-badge.platform-instantly {
            border-color: rgba(34, 197, 94, 0.5);
            color: #34d399;
            background: rgba(16, 185, 129, 0.1);
        }

        .route-badge.platform-ghl {
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        .route-badge.platform-heyreach {
            border-color: rgba(244, 114, 182, 0.5);
            color: #f472b6;
            background: rgba(244, 114, 182, 0.12);
        }

        .campaign-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 1px 7px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.02);
        }

        .email-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-approve {
            background: var(--green);
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-reject {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--red);
            cursor: pointer;
        }

        .btn-reject:hover {
            background: var(--red-bg);
        }

        .btn-preview {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .btn-preview:hover {
            background: var(--bg-hover);
        }

        /* TWO COLUMN LAYOUT */
        .two-col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* ACTIVITY FEED */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.sent {
            background: var(--green-bg);
        }

        .activity-icon.reply {
            background: var(--blue-bg);
        }

        .activity-icon.meeting {
            background: var(--yellow-bg);
        }

        .activity-text {
            flex: 1;
        }

        .activity-text p {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .activity-text span {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* EMAIL PREVIEW MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-sidebar {
            background: var(--bg-dark);
            border-left: 1px solid var(--border);
            padding-left: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .email-preview-field {
            margin-bottom: 16px;
        }

        .email-preview-field label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .email-preview-field .value {
            font-size: 14px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .email-preview-field .body {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* EMAIL BODY EDIT STYLES - FOR HTML RENDERING FIX */
        .body-edit {
            width: 100%;
            min-height: 200px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .body-edit p {
            margin-bottom: 1em;
        }

        .body-edit ul,
        .body-edit ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .body-edit li {
            margin-bottom: 4px;
        }

        .body-edit a {
            color: var(--blue);
            text-decoration: underline;
            cursor: pointer;
        }

        .body-edit br {
            display: block;
            content: "";
            margin-top: 0.5em;
        }

        .body-edit strong,
        .body-edit b {
            font-weight: 600;
            color: var(--text-primary);
        }

        .body-edit em,
        .body-edit i {
            font-style: italic;
        }

        .body-edit blockquote {
            border-left: 3px solid var(--blue);
            padding-left: 12px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        .body-edit:focus {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        .body-edit img {
            max-width: 100%;
            height: auto;
        }

        .body-edit:empty:before {
            content: "Click to edit email body...";
            color: var(--text-muted);
            font-style: italic;
        }

        .feedback-input {
            width: 100%;
            min-height: 80px;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            margin-top: 4px;
        }

        .feedback-select {
            width: 100%;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            font-family: inherit;
            margin-top: 4px;
        }

        .field-help {
            display: block;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* SIDEBAR LAYOUT */
        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-field {
            margin-bottom: 12px;
        }

        .sidebar-field label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .sidebar-field .value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .signal-checklist {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 6px;
        }

        .signal-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            width: fit-content;
            border: 1px solid var(--border);
            background: var(--bg-dark);
        }

        .signal-item.pass {
            border-color: rgba(16, 185, 129, 0.45);
            color: var(--green);
        }

        .signal-item.warn {
            border-color: rgba(251, 191, 36, 0.45);
            color: var(--yellow);
        }

        /* TAB CONTENT PANELS */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* AGENT HEALTH GRID */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        @media (max-width: 1024px) { .agent-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 640px) { .agent-grid { grid-template-columns: 1fr; } }

        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.2s;
        }
        .agent-card:hover { border-color: var(--blue); }

        .agent-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .agent-dot.healthy { background: var(--green); }
        .agent-dot.degraded { background: var(--yellow); }
        .agent-dot.down { background: var(--red); }

        .agent-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: capitalize;
        }
        .agent-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* PIPELINE FUNNEL */
        .funnel-container { margin-bottom: 32px; }
        .funnel-bar {
            display: flex;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-hover);
        }
        .funnel-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            min-width: 40px;
            transition: flex 0.3s;
        }
        .funnel-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .funnel-label {
            text-align: center;
            flex: 1;
        }
        .funnel-label .count {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        /* DISPATCH HISTORY TABLE */
        .dispatch-table {
            width: 100%;
            border-collapse: collapse;
        }
        .dispatch-table th {
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .dispatch-table td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }
        .dispatch-table tr:hover { background: var(--bg-hover); }

        .badge-success { background: var(--green-bg); color: var(--green); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-partial { background: var(--yellow-bg); color: var(--yellow); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-failed { background: var(--red-bg); color: var(--red); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-motion { background: var(--blue-bg); color: var(--blue); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }

        /* SETTINGS SECTIONS */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 768px) { .settings-grid { grid-template-columns: 1fr; } }

        .setting-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }
        .setting-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        }
        .setting-row:last-child { border-bottom: none; }
        .setting-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .setting-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-indicator.ok .dot { background: var(--green); }
        .status-indicator.ok { color: var(--green); }
        .status-indicator.warn .dot { background: var(--yellow); }
        .status-indicator.warn { color: var(--yellow); }
        .status-indicator.error .dot { background: var(--red); }
        .status-indicator.error { color: var(--red); }

        /* RAMP PROGRESS */
        .ramp-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .ramp-step {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid var(--border);
            color: var(--text-muted);
        }
        .ramp-step.complete { border-color: var(--green); color: var(--green); background: var(--green-bg); }
        .ramp-step.current { border-color: var(--blue); color: var(--blue); background: var(--blue-bg); }
        .ramp-connector {
            flex: 1;
            height: 2px;
            background: var(--border);
        }
        .ramp-connector.complete { background: var(--green); }

        /* QUICK LINKS */
        .quick-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .quick-link {
            padding: 10px 16px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--blue);
            font-size: 13px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .quick-link:hover { background: var(--blue-bg); border-color: var(--blue); }

        /* SECTION HEADERS FOR NEW TABS */
        .tab-header {
            margin-bottom: 24px;
        }
        .tab-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .tab-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* REVIEWED HISTORY MINI TABLE */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .history-item:last-child { border-bottom: none; }
        .history-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .history-status.approved { background: var(--green-bg); color: var(--green); }
        .history-status.rejected { background: var(--red-bg); color: var(--red); }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="nav-brand">
            <span>ðŸ“Š</span>
            <span>ChiefAIOfficer Sales Dashboard <small
                    style="font-size:11px; color:#666; margin-left:8px;">v3.0</small></span>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('emails')">Email Queue</button>
            <button class="nav-tab" onclick="showTab('campaigns')">Campaigns</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>
        <div class="nav-user">
            <div class="status">
                <span class="dot"></span>
                <span>Swarm Active</span>
            </div>
            <span style="color: var(--text-secondary); font-size: 14px;">Dani Apgar</span>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- RAMP MODE BANNER â€” GLOBAL (visible on all tabs) -->
        <div class="ramp-banner" id="rampBanner">
            <div class="ramp-info">
                <span class="ramp-icon">&#9650;</span>
                <div class="ramp-text">
                    <strong>RAMP MODE</strong> â€” Supervised go-live in progress.
                    <span id="rampDetail">Loading...</span>
                </div>
            </div>
            <div class="ramp-stats">
                <div class="ramp-stat">
                    <span class="stat-value" id="rampDay">-</span>
                    <span class="stat-label">Day</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampLimit">-</span>
                    <span class="stat-label">Daily Limit</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampTier">-</span>
                    <span class="stat-label">Tier Filter</span>
                </div>
                <div class="ramp-stat">
                    <span class="stat-value" id="rampSent">-</span>
                    <span class="stat-label">Sent Today</span>
                </div>
            </div>
        </div>

        <!-- ========== TAB: OVERVIEW ========== -->
        <div id="tab-overview" class="tab-content active">

            <div class="constraint-banner" id="constraintBanner">
                <div class="constraint-left">
                    <span class="constraint-icon">!</span>
                    <div class="constraint-text">
                        <h3>Your #1 Constraint</h3>
                        <p id="constraintMessage">Loading...</p>
                    </div>
                </div>
                <div class="constraint-actions">
                    <button class="btn btn-primary" onclick="viewConstraintFix()">View Fix</button>
                    <button class="btn btn-secondary" onclick="snoozeConstraint()">Snooze 24h</button>
                </div>
            </div>

            <!-- SCORECARD (live from /api/scorecard) -->
            <div class="scorecard" id="scorecardGrid">
                <div class="metric-card" id="metric-emails-sent">
                    <div class="metric-header">
                        <span class="metric-label">Emails Sent</span>
                    </div>
                    <div class="metric-value" id="emailsSent">--</div>
                    <div class="metric-target" id="emailsSentTarget">Loading...</div>
                    <div class="metric-trend" id="emailsSentTrend"></div>
                </div>
                <div class="metric-card" id="metric-reply-rate">
                    <div class="metric-header">
                        <span class="metric-label">Reply Rate</span>
                    </div>
                    <div class="metric-value" id="replyRate">--</div>
                    <div class="metric-target" id="replyRateTarget">Loading...</div>
                    <div class="metric-trend" id="replyRateTrend"></div>
                </div>
                <div class="metric-card" id="metric-meetings">
                    <div class="metric-header">
                        <span class="metric-label">Meetings Booked</span>
                    </div>
                    <div class="metric-value" id="meetingsBooked">--</div>
                    <div class="metric-target" id="meetingsBookedTarget">Loading...</div>
                    <div class="metric-trend" id="meetingsBookedTrend"></div>
                </div>
                <div class="metric-card" id="metric-pipeline">
                    <div class="metric-header">
                        <span class="metric-label">Pipeline Value</span>
                    </div>
                    <div class="metric-value" id="pipelineValue">--</div>
                    <div class="metric-target" id="pipelineValueTarget">Loading...</div>
                    <div class="metric-trend" id="pipelineValueTrend"></div>
                </div>
            </div>

            <!-- AGENT HEALTH -->
            <div class="section" style="padding: 20px 24px; margin-bottom: 24px;">
                <h2 class="section-title" style="margin-bottom: 16px;">Agent Health (12 Agents)</h2>
                <div class="agent-grid" id="agentGrid">
                    <div class="agent-card"><span class="agent-dot degraded"></span><div><div class="agent-name">Loading agents...</div></div></div>
                </div>
            </div>

            <!-- PIPELINE FUNNEL -->
            <div class="section funnel-container" style="padding: 20px 24px; margin-bottom: 24px;">
                <h2 class="section-title" style="margin-bottom: 16px;">Pipeline Funnel</h2>
                <div class="funnel-bar" id="funnelBar"></div>
                <div class="funnel-labels" id="funnelLabels"></div>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                </div>
                <div id="activityFeed">
                    <!-- Activity items populated by JS -->
                </div>
            </div>
        </div>

        <!-- ========== TAB: EMAIL QUEUE ========== -->
        <div id="tab-emails" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 12px; color: var(--text-muted);">
                <span>Last refresh: <span id="lastRefreshLabel">--</span></span>
                <span>Next poll in <span id="nextPollCountdown">--</span>s</span>
            </div>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Pending Email Approvals</h2>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterEmails('all')">All</button>
                        <button class="filter-btn" onclick="filterEmails('hot')">Hot</button>
                        <button class="filter-btn" onclick="filterEmails('warm')">Warm</button>
                        <button class="filter-btn" onclick="filterEmails('low')">Low</button>
                        <span class="section-badge" id="pendingCount">0</span>
                        <div class="bulk-actions">
                            <button class="btn-sm btn-primary" onclick="bulkApprove()">Approve All Low</button>
                        </div>
                    </div>
                </div>
                <div class="email-list" id="emailList">
                    <!-- Email items populated by JS -->
                </div>
            </div>

            <!-- RECENTLY REVIEWED -->
            <div class="section" style="margin-top: 24px;">
                <div class="section-header">
                    <h2 class="section-title">Recently Reviewed</h2>
                </div>
                <div id="reviewedHistory">
                    <div class="empty-state" style="padding: 24px; text-align: center; color: var(--text-muted);">Loading history...</div>
                </div>
            </div>

            <!-- QUEUE DIAGNOSTICS (collapsed by default) -->
            <details style="margin-top: 16px;">
                <summary style="cursor:pointer; color: var(--text-muted); font-size: 12px; padding: 8px 0;">Queue Diagnostics (Debug)</summary>
                <div class="section" style="margin-top: 8px; padding: 16px;">
                    <pre id="queueDiagnostics" style="font-size: 12px; color: var(--text-secondary); white-space: pre-wrap; word-break: break-all;">Loading...</pre>
                </div>
            </details>
        </div>

        <!-- ========== TAB: CAMPAIGNS ========== -->
        <div id="tab-campaigns" class="tab-content">
            <div class="tab-header">
                <h2>Campaign Operations</h2>
                <p>Dispatch history, cadence pipeline, and campaign performance</p>
            </div>

            <!-- CAMPAIGN SUMMARY CARDS -->
            <div class="scorecard" id="campaignCards">
                <div class="metric-card">
                    <div class="metric-header"><span class="metric-label">Sent Today</span></div>
                    <div class="metric-value" id="campaignSentToday">--</div>
                    <div class="metric-target" id="campaignSentLimit">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span class="metric-label">Cadence Active</span></div>
                    <div class="metric-value" id="cadenceActive">--</div>
                    <div class="metric-target">Leads in active sequences</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span class="metric-label">Due Today</span></div>
                    <div class="metric-value" id="cadenceDueToday">--</div>
                    <div class="metric-target">Cadence actions pending</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header"><span class="metric-label">Total Dispatched (7d)</span></div>
                    <div class="metric-value" id="totalDispatched7d">--</div>
                    <div class="metric-target">Across all motions</div>
                </div>
            </div>

            <!-- DISPATCH HISTORY -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Dispatch History</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table class="dispatch-table" id="dispatchTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Motion</th>
                                <th>Dispatched</th>
                                <th>Platform</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="dispatchTableBody">
                            <tr><td colspan="5" style="text-align:center; color: var(--text-muted); padding: 24px;">Loading dispatch history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CADENCE PIPELINE -->
            <div class="section" style="margin-top: 24px;">
                <div class="section-header">
                    <h2 class="section-title">Cadence Pipeline</h2>
                </div>
                <div id="cadencePipeline" style="padding: 16px;">
                    <div style="text-align:center; color: var(--text-muted); padding: 24px;">Loading cadence data...</div>
                </div>
            </div>
        </div>

        <!-- ========== TAB: SETTINGS ========== -->
        <div id="tab-settings" class="tab-content">
            <div class="tab-header">
                <h2>System Settings</h2>
                <p>Configuration, safety controls, and system dependencies (read-only)</p>
            </div>

            <div class="settings-grid">
                <!-- RAMP MODE -->
                <div class="setting-card">
                    <h3>Ramp Mode</h3>
                    <div id="settingsRamp">
                        <div class="setting-row">
                            <span class="setting-label">Status</span>
                            <span class="setting-value" id="settingsRampStatus">Loading...</span>
                        </div>
                        <div class="setting-row">
                            <span class="setting-label">Day</span>
                            <span class="setting-value" id="settingsRampDay">--</span>
                        </div>
                        <div class="setting-row">
                            <span class="setting-label">Tier Filter</span>
                            <span class="setting-value" id="settingsRampTier">--</span>
                        </div>
                        <div class="setting-row">
                            <span class="setting-label">Daily Limit</span>
                            <span class="setting-value" id="settingsRampLimit">--</span>
                        </div>
                    </div>
                    <div class="ramp-progress" id="rampProgressBar"></div>
                </div>

                <!-- EMERGENCY CONTROLS -->
                <div class="setting-card">
                    <h3>Safety Controls</h3>
                    <div class="setting-row">
                        <span class="setting-label">Emergency Stop</span>
                        <span id="settingsEmergencyStop" class="status-indicator ok"><span class="dot"></span> INACTIVE</span>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Shadow Mode</span>
                        <span id="settingsShadowMode" class="status-indicator warn"><span class="dot"></span> ACTIVE</span>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Gatekeeper Gate</span>
                        <span id="settingsGatekeeper" class="status-indicator ok"><span class="dot"></span> ENABLED</span>
                    </div>
                </div>

                <!-- SYSTEM DEPENDENCIES -->
                <div class="setting-card">
                    <h3>System Dependencies</h3>
                    <div id="settingsDeps">
                        <div class="setting-row">
                            <span class="setting-label">Redis (Upstash)</span>
                            <span id="settingsRedis" class="status-indicator ok"><span class="dot"></span> Loading...</span>
                        </div>
                        <div class="setting-row">
                            <span class="setting-label">Inngest</span>
                            <span id="settingsInngest" class="status-indicator ok"><span class="dot"></span> Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- GUARDRAILS -->
                <div class="setting-card">
                    <h3>Guardrails &amp; Rate Limits</h3>
                    <div id="settingsGuardrails">
                        <div style="text-align:center; color: var(--text-muted); padding: 12px;">Loading guardrails...</div>
                    </div>
                </div>
            </div>

            <!-- QUICK LINKS -->
            <div class="section" style="padding: 20px 24px;">
                <h2 class="section-title" style="margin-bottom: 16px;">Quick Reference Links</h2>
                <div class="quick-links">
                    <a href="/" class="quick-link" target="_blank">System Health Dashboard</a>
                    <a href="/scorecard" class="quick-link" target="_blank">Precision Scorecard</a>
                    <a href="/leads" class="quick-link" target="_blank">Lead Signal Loop</a>
                    <a href="https://app.instantly.ai" class="quick-link" target="_blank" rel="noopener">Instantly Dashboard</a>
                    <a href="https://app.gohighlevel.com" class="quick-link" target="_blank" rel="noopener">GHL Dashboard</a>
                </div>
            </div>
        </div>

    </main>

    <!-- EMAIL PREVIEW MODAL -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Email Editor &amp; Preview</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="emailPreviewBody">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-reject btn-sm" onclick="rejectEmail()">Reject</button>
                <button class="btn btn-approve" onclick="approveEmail()">âœ“ Approve &amp; Send</button>
            </div>
        </div>
    </div>

    <!-- Error Reporter for debug-mcp correlation -->
    <script src="/static/error-reporter.js"></script>
    <script>
        const pendingEmails = [];
        const recentActivity = [];
        let lastRefreshAt = null;
        let refreshInFlight = false;
        const REFRESH_INTERVAL_MS = 15000;
        const TOKEN_STORAGE_KEY = `caio_dashboard_token_${window.location.host}`;
        const LEGACY_TOKEN_STORAGE_KEY = 'caio_dashboard_token';

        let tokenPrompted = false;
        let authRequiredForQueue = false;
        let lastPendingFetchError = '';
        let hasSuccessfulQueueFetch = false;

        function persistToken(token) {
            if (!token) return;
            localStorage.setItem(TOKEN_STORAGE_KEY, token);
            localStorage.setItem(LEGACY_TOKEN_STORAGE_KEY, token);
        }

        function clearPersistedToken() {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            localStorage.removeItem(LEGACY_TOKEN_STORAGE_KEY);
        }

        function getToken({ promptFallback = false, forcePrompt = false } = {}) {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromQuery = urlParams.get('token');
            if (tokenFromQuery && tokenFromQuery.trim()) {
                const normalized = tokenFromQuery.trim();
                persistToken(normalized);
                return normalized;
            }

            if (!forcePrompt) {
                const tokenFromStorage = localStorage.getItem(TOKEN_STORAGE_KEY);
                if (tokenFromStorage && tokenFromStorage.trim()) {
                    return tokenFromStorage.trim();
                }
                const tokenFromLegacyStorage = localStorage.getItem(LEGACY_TOKEN_STORAGE_KEY);
                if (tokenFromLegacyStorage && tokenFromLegacyStorage.trim()) {
                    const normalized = tokenFromLegacyStorage.trim();
                    localStorage.setItem(TOKEN_STORAGE_KEY, normalized);
                    return normalized;
                }
            } else {
                clearPersistedToken();
                tokenPrompted = false;
            }

            if (promptFallback && !tokenPrompted) {
                tokenPrompted = true;
                const tokenFromPrompt = window.prompt('Enter dashboard token for protected API access:');
                if (tokenFromPrompt && tokenFromPrompt.trim()) {
                    const normalized = tokenFromPrompt.trim();
                    persistToken(normalized);
                    authRequiredForQueue = false;
                    lastPendingFetchError = '';
                    return normalized;
                }
            }
            return '';
        }

        function promptForDashboardToken() {
            const token = getToken({ promptFallback: true, forcePrompt: true });
            if (token) {
                loadRejectionTagOptions({ token, silent: true });
                fetchPendingEmails({ silent: false });
            }
        }

        function buildAuthHeaders(baseHeaders = {}, token = '') {
            const headers = { ...baseHeaders };
            if (token) {
                headers['X-Dashboard-Token'] = token;
            }
            return headers;
        }

        function buildPendingEmailsUrl(token = '') {
            const params = new URLSearchParams();
            if (token) {
                params.set('token', token);
            }
            params.set('_ts', String(Date.now()));
            return `/api/pending-emails?${params.toString()}`;
        }

        async function loadRejectionTagOptions({ token = '', silent = true } = {}) {
            try {
                const authToken = token || getToken({ promptFallback: false });
                const query = authToken ? `?token=${encodeURIComponent(authToken)}` : '';
                const response = await fetch(`/api/rejection-tags${query}`, {
                    headers: buildAuthHeaders({ 'Accept': 'application/json' }, authToken)
                });
                if (!response.ok) {
                    throw new Error(`Failed to load rejection tags (${response.status})`);
                }
                const data = await response.json();
                if (Array.isArray(data.tags) && data.tags.length > 0) {
                    rejectionTagOptions = data.tags
                        .filter((tag) => tag && tag.id)
                        .map((tag) => ({ id: String(tag.id), label: String(tag.label || tag.id) }));
                }
            } catch (error) {
                rejectionTagOptions = [...REJECTION_TAG_OPTIONS];
                if (!silent) {
                    showToast(`Using fallback rejection tags: ${error.message}`);
                }
            }
        }

        function normalizeTierValue(tier = 'tier_3') {
            const value = String(tier || 'tier_3').toLowerCase();
            return value.startsWith('tier_') ? value : `tier_${value.replace(/[^\d]/g, '') || '3'}`;
        }

        function normalizeTierClass(tier = 'tier_3') {
            return normalizeTierValue(tier).replace('_', '');
        }

        function formatTierLabel(tier = 'tier_3') {
            const value = normalizeTierValue(tier);
            const suffix = value.split('_')[1] || '3';
            return `TIER ${suffix}`;
        }

        function formatPlatformBadge(email) {
            const platform = (email.targetPlatform || 'unknown').toLowerCase();
            const direction = (email.direction || 'outbound').toUpperCase();
            const safePlatform = escapeHtml(platform);
            const label = platform === 'unknown' ? `${direction} Â· UNKNOWN` : `${direction} Â· ${platform.toUpperCase()}`;
            return `<span class="route-badge platform-${safePlatform}">${escapeHtml(label)}</span>`;
        }

        function formatCampaignLine(email) {
            const campaignType = escapeHtml(email.campaignType || 'unmapped');
            const campaignId = escapeHtml(email.campaignId || 'none');
            const syncState = escapeHtml(email.syncState || 'unknown');
            return `<span class="campaign-chip">Campaign: ${campaignType} (${campaignId})</span><span class="campaign-chip">Sync: ${syncState}</span>`;
        }

        function formatProofLine(email) {
            const status = String(email.proofStatus || 'not_started');
            let label = 'Proof: Not started';
            if (status === 'proved') label = 'Proof: Sent (proved)';
            if (status === 'unresolved') label = 'Proof: Sent (unresolved)';
            if (status === 'pending') label = 'Proof: Queued for proof';
            const source = escapeHtml(email.proofSource || 'none');
            return `<span class="campaign-chip">${escapeHtml(label)}</span><span class="campaign-chip">Source: ${source}</span>`;
        }

        function formatDeliverabilityLine(email) {
            const risk = String(email.deliverabilityRisk || 'unknown').toLowerCase();
            const reasons = Array.isArray(email.deliverabilityReasons) ? email.deliverabilityReasons : [];
            const reasonText = reasons.length ? escapeHtml(reasons.join(', ')) : 'none';
            return `<span class="campaign-chip">Deliverability: ${escapeHtml(risk)}</span><span class="campaign-chip">Reasons: ${reasonText}</span>`;
        }

        function escapeHtml(value = '') {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeRegExp(value = '') {
            return String(value).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function decodeHtmlEntities(value = '') {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = String(value || '');
            return textarea.value;
        }

        function extractFirstName(fullName = '') {
            const cleaned = String(fullName || '').trim();
            if (!cleaned) return 'there';
            return cleaned.split(/\s+/)[0];
        }

        function normalizeEmailBody(rawBody = '') {
            let text = String(rawBody || '');
            text = text.replace(/<style[\s\S]*?<\/style>/gi, '');
            text = text.replace(/<script[\s\S]*?<\/script>/gi, '');
            text = text.replace(/<\/p>/gi, '\n\n').replace(/<p[^>]*>/gi, '');
            text = text.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<\/div>/gi, '\n').replace(/<div[^>]*>/gi, '');
            text = text.replace(/<li[^>]*>/gi, '- ').replace(/<\/li>/gi, '\n');
            text = text.replace(/<\/?ul[^>]*>/gi, '').replace(/<\/?ol[^>]*>/gi, '');
            text = text.replace(/<[^>]+>/g, '');
            text = decodeHtmlEntities(text);
            text = text.replace(/\r\n?/g, '\n');
            text = text.replace(/\u00a0/g, ' ');
            text = text.replace(/[ \t]+\n/g, '\n');
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        const CALL_LINK = 'https://caio.cx/ai-exec-briefing-call';

        const STANDARD_SIGNATURE_BLOCK = [
            'Best,',
            'Dani Apgar',
            'Schedule a call with CAIO',
        ].join('\n');

        const STANDARD_FOOTER_BLOCK = [
            "We only reach out to professionals we believe can lead AI strategy inside their organizations. If this isn't you, or now's not the right time, just Reply STOP to unsubscribe.",
            'Chief AI Officer Inc.',
            '5700 Harper Dr, Suite 210, Albuquerque, NM 87109',
            'support@chiefaiofficer.com',
            'Copyright Â© 2026 Chief AI Officer. All rights reserved',
        ].join('\n');

        const REJECTION_TAG_OPTIONS = [
            { id: 'personalization_mismatch', label: 'Personalization mismatch' },
            { id: 'icp_mismatch', label: 'ICP mismatch' },
            { id: 'campaign_mismatch', label: 'Campaign mismatch' },
            { id: 'tone_style_issue', label: 'Tone/style issue' },
            { id: 'factual_inaccuracy', label: 'Factual inaccuracy' },
            { id: 'weak_subject', label: 'Weak subject line' },
            { id: 'weak_cta', label: 'Weak CTA' },
            { id: 'length_issue', label: 'Length/structure issue' },
            { id: 'compliance_issue', label: 'Compliance issue' },
            { id: 'placeholder_or_rendering_issue', label: 'Placeholder/rendering issue' },
            { id: 'other', label: 'Other' },
        ];
        let rejectionTagOptions = [...REJECTION_TAG_OPTIONS];

        function renderRejectionTagOptions() {
            const options = rejectionTagOptions.map(
                (item) => `<option value="${escapeHtml(item.id)}">${escapeHtml(item.label)}</option>`
            ).join('');
            return `<option value="">Select required rejection tag...</option>${options}`;
        }

        function stripLegacySignatureFooter(rawText = '') {
            let cleaned = String(rawText || '');
            cleaned = cleaned.replace(/\n*We only reach out to professionals we believe can lead AI strategy inside their organizations\.[\s\S]*$/i, '');
            cleaned = cleaned.replace(/\n*(Best,|Cheers,|Thanks,)\s*\n[\s\S]*$/i, '');
            cleaned = cleaned.replace(/\n*---\s*\n[\s\S]*$/i, '');
            cleaned = cleaned.replace(/\n*Reply STOP to unsubscribe\.?\s*$/gi, '');
            cleaned = cleaned.replace(/\n*Chief AI Officer Inc\.[\s\S]*$/i, '');
            cleaned = cleaned.replace(/[ \t]+\n/g, '\n');
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
            return cleaned.trim();
        }

        function appendStandardSignatureFooter(rawText = '') {
            const cleaned = stripLegacySignatureFooter(rawText);
            if (!cleaned) {
                return `${STANDARD_SIGNATURE_BLOCK}\n\n${STANDARD_FOOTER_BLOCK}`;
            }
            return `${cleaned}\n\n${STANDARD_SIGNATURE_BLOCK}\n\n${STANDARD_FOOTER_BLOCK}`.trim();
        }

        function renderEditableBodyHtml(rawText = '') {
            const text = String(rawText || 'No Body Content');
            let html = escapeHtml(text).replace(/\r\n?/g, '\n').replace(/\n/g, '<br>');
            html = html.replace(
                /Schedule a call with CAIO/g,
                `<a href="${CALL_LINK}" target="_blank" rel="noopener noreferrer">Schedule a call with CAIO</a>`
            );
            html = html.replace(
                /support@chiefaiofficer\.com/g,
                '<a href="mailto:support@chiefaiofficer.com">support@chiefaiofficer.com</a>'
            );
            return html;
        }

        function formatCopyForApproval(rawBody = '', email = {}) {
            let text = normalizeEmailBody(rawBody);
            const firstName = extractFirstName(email.recipientName || '');
            const company = (email.company && email.company !== 'Unknown Corp') ? email.company : '';
            const industry = (email.industry && email.industry !== 'N/A') ? email.industry : '';
            const title = (email.title && email.title !== 'Unknown Title') ? email.title : '';

            if (!text || /^no body content$/i.test(text)) {
                const signalLine = title && company
                    ? `Given your role as ${title} at ${company}, this felt relevant.`
                    : company
                        ? `Noticed ${company}${industry ? ` in ${industry}` : ''} and wanted to share a practical AI execution path.`
                        : 'Wanted to share a practical AI execution path that has worked for similar teams.';
                return appendStandardSignatureFooter(
                    `Hi ${firstName},\n\n${signalLine}\n\nWould it be useful if I send a one-page plan with 2-3 workflows worth piloting first?`
                );
            }

            text = text.replace(/^Hi\s+([^\n,]+),\s*/i, 'Hi $1,\n\n');
            text = text.replace(/\.\s+(Usually,|Most teams|We step in|We act as|How we run it:|What that looks like:|If useful,|Worth a brief chat|Open to|Would it be helpful)/g, '.\n\n$1');
            text = text.replace(/\s+(How we run it:|What that looks like:)/g, '\n\n$1');
            text = text.replace(/(How we run it:|What that looks like:)\s*- /g, '$1\n- ');
            text = text.replace(/\s-\s(?=[A-Za-z0-9][^:\n]{2,60}:)/g, '\n- ');
            text = text.replace(/\n-\s*/g, '\n- ');
            text = text.replace(/\s+(Best,|Cheers,|Thanks,)\s+/g, '\n\n$1\n');
            text = text.replace(/\s+---\s+/g, '\n\n---\n');
            text = text.replace(/\s+(Reply STOP to unsubscribe\.)/i, '\n$1');

            if (normalizeTierValue(email.tier || 'tier_3') === 'tier_1') {
                const hasCompany = company && new RegExp(escapeRegExp(company), 'i').test(text);
                const roleAnchor = title.split(',')[0].trim();
                const hasRole = roleAnchor && roleAnchor.length >= 4 && new RegExp(escapeRegExp(roleAnchor), 'i').test(text);
                if (company && (!hasCompany || !hasRole)) {
                    const signalLine = title
                        ? `Given your role as ${title} at ${company}, this felt relevant.`
                        : `Noticed ${company}${industry ? ` in ${industry}` : ''} and wanted to share a practical AI execution path.`;
                    text = text.replace(/^Hi\s+[^\n,]+,\n\n/i, (match) => `${match}${signalLine}\n\n`);
                }
            }

            text = text.replace(/[ \t]+\n/g, '\n');
            text = text.replace(/\n{3,}/g, '\n\n');
            return appendStandardSignatureFooter(text);
        }

        function buildCopySignalChecks(email = {}, bodyText = '') {
            const body = String(bodyText || '');
            const lower = body.toLowerCase();
            const firstName = extractFirstName(email.recipientName || '').toLowerCase();
            const company = String(email.company || '').toLowerCase();
            const title = String(email.title || '').toLowerCase();
            const roleAnchor = title.split(',')[0].trim();

            const checks = [
                {
                    label: 'Personalization (name + company)',
                    pass: !!firstName && lower.includes(firstName) && !!company && lower.includes(company),
                },
                {
                    label: 'Role-aware context',
                    pass: !!roleAnchor && roleAnchor.length >= 4 && lower.includes(roleAnchor),
                },
                {
                    label: 'Business outcome signal',
                    pass: /(roi|kpi|pipeline|conversion|time saved|productivity|revenue|velocity|meetings)/i.test(body),
                },
                {
                    label: 'Clear CTA',
                    pass: /(\?|15\s*-?\s*minute|quick call|open to|if useful|worth a brief chat)/i.test(body),
                },
                {
                    label: 'Compliance footer',
                    pass: /(reply stop to unsubscribe|we only reach out to professionals we believe can lead ai strategy inside their organizations|support@chiefaiofficer\.com)/i.test(body),
                },
            ];
            return checks;
        }

        function renderSignalChecklist(checks = []) {
            return checks.map((item) => {
                const cls = item.pass ? 'pass' : 'warn';
                const icon = item.pass ? 'OK' : '!!';
                return `<span class="signal-item ${cls}">${icon} ${escapeHtml(item.label)}</span>`;
            }).join('');
        }

        function renderComplianceChecks(checks = {}) {
            const items = [
                { label: 'Reply STOP present', pass: !!checks.reply_stop_present },
                { label: 'Signature present', pass: !!checks.signature_present },
                { label: 'CTA link present', pass: !!checks.cta_present },
                { label: 'Footer present', pass: !!checks.footer_present },
            ];
            return items.map(item => {
                const cls = item.pass ? 'pass' : 'warn';
                const icon = item.pass ? 'OK' : '!!';
                return `<span class="signal-item ${cls}">${icon} ${escapeHtml(item.label)}</span>`;
            }).join('');
        }

        async function fetchPendingEmails({ silent = false } = {}) {
            if (refreshInFlight) return;
            refreshInFlight = true;
            try {
                let token = getToken({ promptFallback: !silent });
                let response = await fetch(buildPendingEmailsUrl(token), {
                    method: 'GET',
                    cache: 'no-store',
                    headers: buildAuthHeaders({ 'Accept': 'application/json' }, token)
                });

                if (response.status === 401) {
                    authRequiredForQueue = true;
                    lastPendingFetchError = 'Dashboard token missing or invalid. Open /sales?token=<DASHBOARD_AUTH_TOKEN> or click Re-enter Token.';
                    clearPersistedToken();
                }

                if (response.status === 401 && !silent) {
                    token = getToken({ promptFallback: true, forcePrompt: true });
                    response = await fetch(buildPendingEmailsUrl(token), {
                        method: 'GET',
                        cache: 'no-store',
                        headers: buildAuthHeaders({ 'Accept': 'application/json' }, token)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                authRequiredForQueue = false;
                lastPendingFetchError = '';
                hasSuccessfulQueueFetch = true;
                const data = await response.json();
                pendingEmails.length = 0;

                const emails = Array.isArray(data.pending_emails) ? data.pending_emails : [];
                emails.forEach(e => {
                    const recipientEmail = e.to || 'unknown@example.com';
                    const classifier = e.classifier || {};
                    const campaignRef = e.campaign_ref || {};
                    const tier = normalizeTierValue(e.tier || 'tier_3');
                    const complianceChecks = e.compliance_checks || {};
                    const queuedEmail = {
                        id: e.email_id,
                        tier,
                        tierClass: normalizeTierClass(tier),
                        tierLabel: formatTierLabel(tier),
                        subject: e.subject || 'No Subject',
                        recipient: recipientEmail,
                        recipientName: e.recipient_data?.name || recipientEmail.split('@')[0],
                        company: e.recipient_data?.company || 'Unknown Corp',
                        title: e.recipient_data?.title || 'Unknown Title',
                        location: e.recipient_data?.location || 'Unknown Location',
                        employees: e.recipient_data?.employees || 'N/A',
                        industry: e.recipient_data?.industry || 'N/A',
                        angle: e.angle || 'General',
                        timestamp: 'Just now',
                        body: e.body || 'No Body Content',
                        direction: classifier.message_direction || e.direction || 'outbound',
                        queueOrigin: classifier.queue_origin || e.source || 'unknown',
                        targetPlatform: classifier.target_platform || e.delivery_platform || 'unknown',
                        targetPlatformReason: classifier.target_platform_reason || 'unknown',
                        routingTargets: Array.isArray(classifier.routing_targets) ? classifier.routing_targets : [],
                        syncState: classifier.sync_state || 'unknown',
                        leadSourceClass: classifier.lead_source_class || 'unknown',
                        campaignId: campaignRef.internal_id || e.context?.campaign_id || 'none',
                        campaignType: campaignRef.internal_type || e.context?.campaign_type || 'unmapped',
                        campaignName: campaignRef.internal_name || e.context?.campaign_name || '',
                        pipelineRunId: campaignRef.pipeline_run_id || e.context?.pipeline_run_id || '',
                        externalProvider: campaignRef.external_provider || '',
                        externalCampaignId: campaignRef.external_campaign_id || '',
                        externalCampaignName: campaignRef.external_campaign_name || '',
                        proofStatus: e.proof_status || 'not_started',
                        proofSource: e.proof_source || 'none',
                        proofTimestamp: e.proof_timestamp || '',
                        proofEvidenceId: e.proof_evidence_id || '',
                        deliverabilityRisk: e.deliverability_risk || 'unknown',
                        deliverabilityReasons: Array.isArray(e.deliverability_reasons) ? e.deliverability_reasons : [],
                        modelRoute: e.model_route || 'unknown',
                        canary: !!e.canary,
                        complianceChecks: complianceChecks
                    };
                    queuedEmail.body = formatCopyForApproval(queuedEmail.body, queuedEmail);
                    queuedEmail.copySignals = buildCopySignalChecks(queuedEmail, queuedEmail.body);
                    pendingEmails.push(queuedEmail);
                });

                lastRefreshAt = data.refreshed_at || new Date().toISOString();
                if (typeof lastRefreshTime !== 'undefined') lastRefreshTime = Date.now();
                renderPendingEmails();

                // Update queue diagnostics if visible
                if (data._shadow_queue_debug) {
                    const diagEl = document.getElementById('queueDiagnostics');
                    if (diagEl) diagEl.textContent = JSON.stringify(data._shadow_queue_debug, null, 2);
                }

                if (!silent) {
                    const synced = data.synced_from_gatekeeper || 0;
                    if (synced > 0) {
                        showToast(`Synced ${synced} queued emails into dashboard inbox`);
                    }
                }
            } catch (e) {
                console.error("Failed to fetch pending emails:", e);
                if (!authRequiredForQueue) {
                    lastPendingFetchError = e.message || 'Unknown refresh error';
                }
                renderPendingEmails();
                if (!silent) {
                    showToast(`Refresh failed: ${e.message}`);
                }
            } finally {
                refreshInFlight = false;
            }
        }

        function startAutoRefresh() {
            loadRejectionTagOptions({ silent: true });
            fetchPendingEmails({ silent: false });
            setInterval(() => {
                fetchPendingEmails({ silent: true });
            }, REFRESH_INTERVAL_MS);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    fetchPendingEmails({ silent: authRequiredForQueue ? false : true });
                }
            });
        }

        function renderPendingEmails() {
            const list = document.getElementById('emailList');

            if (authRequiredForQueue) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ðŸ”’</div>
                        <h3>Authentication Required</h3>
                        <p>${lastPendingFetchError || 'Dashboard token is required to load pending approvals.'}</p>
                        <div style="margin-top: 12px;">
                            <button class="btn-sm btn-secondary" onclick="promptForDashboardToken()">Re-enter Token</button>
                        </div>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '!';
                return;
            }

            if (!hasSuccessfulQueueFetch && lastPendingFetchError) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âš ï¸</div>
                        <h3>Queue Unavailable</h3>
                        <p>${lastPendingFetchError}</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '?';
                return;
            }

            const filteredEmails = currentFilter === 'all'
                ? pendingEmails
                : pendingEmails.filter(e => classifyPriority(e) === currentFilter);

            if (filteredEmails.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âœ…</div>
                        <h3>All caught up!</h3>
                        <p>No pending emails to review</p>
                    </div>
                `;
                document.getElementById('pendingCount').textContent = '0';
                return;
            }

            document.getElementById('pendingCount').textContent = filteredEmails.length;

            list.innerHTML = filteredEmails.map(email => {
                const safeId = escapeHtml(email.id);
                const safeTierClass = escapeHtml(email.tierClass);
                const safeTierLabel = escapeHtml(email.tierLabel);
                const safeSubject = escapeHtml(email.subject);
                const safeRecipientName = escapeHtml(email.recipientName);
                const safeCompany = escapeHtml(email.company);
                const safeAngle = escapeHtml(email.angle);
                const safeTimestamp = escapeHtml(email.timestamp);
                const safeQueueOrigin = escapeHtml(email.queueOrigin);
                return `
                <div class="email-item">
                    <div class="email-info">
                        <div class="email-subject">
                            ${getPriorityBadge(email)}
                            ${email.canary ? '<span style="background:#f59e0b;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-right:6px;">TRAINING</span>' : ''}
                            <span class="email-tier ${safeTierClass}">${safeTierLabel}</span>
                            ${formatPlatformBadge(email)}
                            ${safeSubject}
                        </div>
                        <div class="email-meta">
                            <span>To: ${safeRecipientName} (${safeCompany})</span>
                            <span>Angle: ${safeAngle}</span>
                            <span>${safeTimestamp}</span>
                        </div>
                        <div class="email-meta" style="margin-top: 6px;">
                            <span>${formatCampaignLine(email)}</span>
                            <span>Origin: ${safeQueueOrigin}</span>
                        </div>
                        <div class="email-meta" style="margin-top: 6px;">
                            <span>${formatProofLine(email)}</span>
                        </div>
                        <div class="email-meta" style="margin-top: 6px;">
                            <span>${formatDeliverabilityLine(email)}</span>
                        </div>
                    </div>
                    <div class="email-actions">
                        <button class="btn-sm btn-preview" onclick="previewEmail('${safeId}')">Edit & Preview</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderActivityFeed() {
            const feed = document.getElementById('activityFeed');
            if (recentActivity.length === 0) {
                feed.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon sent">ðŸ“§</div>
                        <div class="activity-text">
                            <p>Swarm is running. Waiting for activity...</p>
                            <span id="activityModeLabel">Live Mode</span>
                        </div>
                    </div>
                `;
                return;
            }

            feed.innerHTML = recentActivity.map(act => `
                <div class="activity-item">
                    <div class="activity-icon ${act.type}">${act.icon}</div>
                    <div class="activity-text">
                        <p>${act.message}</p>
                        <span>${act.time}</span>
                    </div>
                </div>
            `).join('');
        }

        let currentEmailId = null;

        function previewEmail(emailId) {
            currentEmailId = emailId;
            const email = pendingEmails.find(e => e.id === emailId);
            if (!email) return;

            const recipientName = escapeHtml(email.recipientName);
            const recipient = escapeHtml(email.recipient);
            const subject = escapeHtml(email.subject);
            const title = escapeHtml(email.title);
            const company = escapeHtml(email.company);
            const employees = escapeHtml(email.employees);
            const location = escapeHtml(email.location);
            const angle = escapeHtml(email.angle);
            const tierClass = escapeHtml(email.tierClass);
            const tierLabel = escapeHtml(email.tierLabel);
            const direction = escapeHtml((email.direction || 'outbound').toUpperCase());
            const targetPlatform = escapeHtml((email.targetPlatform || 'unknown').toUpperCase());
            const campaignType = escapeHtml(email.campaignType || 'unmapped');
            const campaignId = escapeHtml(email.campaignId || 'none');
            const syncState = escapeHtml(email.syncState || 'unknown');
            const queueOrigin = escapeHtml(email.queueOrigin || 'unknown');
            const leadSourceClass = escapeHtml(email.leadSourceClass || 'unknown');
            const routingTargets = escapeHtml((email.routingTargets || []).join(', ') || 'none');
            const proofStatus = escapeHtml(email.proofStatus || 'not_started');
            const proofSource = escapeHtml(email.proofSource || 'none');
            const proofTimestamp = escapeHtml(email.proofTimestamp || 'n/a');
            const proofEvidenceId = escapeHtml(email.proofEvidenceId || 'n/a');
            const deliverabilityRisk = escapeHtml(email.deliverabilityRisk || 'unknown');
            const deliverabilityReasons = escapeHtml((email.deliverabilityReasons || []).join(', ') || 'none');
            const modelRoute = escapeHtml(email.modelRoute || 'unknown');
            const checksHtml = renderSignalChecklist(email.copySignals || []);

            document.getElementById('emailPreviewBody').innerHTML = `
                <div class="modal-main">
                    ${email.canary ? '<div style="background:#f59e0b;color:#000;padding:8px 16px;border-radius:6px;margin-bottom:12px;font-weight:700;text-align:center;">TRAINING MODE â€” This is a canary email with a synthetic lead. Safe to practice approve/reject.</div>' : ''}
                    <!-- TO -->
                    <div class="email-preview-field">
                        <label>To</label>
                        <div class="value">${recipientName} &lt;${recipient}&gt;</div>
                    </div>
                    <!-- SUBJECT -->
                    <div class="email-preview-field">
                        <label>Subject</label>
                        <div class="value">${subject}</div>
                    </div>
                    <!-- EDITABLE BODY -->
                    <div class="email-preview-field">
                        <label>Email Body (Click to Edit)</label>
                        <div id="emailBodyInput" class="body-edit" contenteditable="true"></div>
                    </div>
                    <!-- FEEDBACK -->
                    <div class="email-preview-field">
                        <label>Feedback for AI (Help the Agents Learn)</label>
                        <textarea id="feedbackInput" class="feedback-input" placeholder="e.g. 'Good angle, but make the intro shorter next time' or 'This person is not a decision maker'"></textarea>
                    </div>
                    <div class="email-preview-field">
                        <label>Rejection Tag (Required to Reject)</label>
                        <select id="rejectionTagInput" class="feedback-select">
                            ${renderRejectionTagOptions()}
                        </select>
                        <small class="field-help">Choose a structured reason tag before rejecting so QA/training remains deterministic.</small>
                    </div>
                </div>
                <div class="modal-sidebar">
                    <div class="sidebar-title">Lead Insights</div>
                    <div class="sidebar-field">
                        <label>Target</label>
                        <div class="value">${recipientName}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Title</label>
                        <div class="value">${title}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Company</label>
                        <div class="value">${company}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Employees</label>
                        <div class="value">${employees}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Location</label>
                        <div class="value">${location}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Angle Used</label>
                        <div class="value"><span class="email-tier ${tierClass}">${tierLabel}</span> ${angle}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Delivery Classifier</label>
                        <div class="value">${direction} â†’ ${targetPlatform}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Campaign Mapping</label>
                        <div class="value">${campaignType} (${campaignId})</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Sync State</label>
                        <div class="value">${syncState}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Queue Origin</label>
                        <div class="value">${queueOrigin} (${leadSourceClass})</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Routing Targets</label>
                        <div class="value">${routingTargets}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Proof Status</label>
                        <div class="value">${proofStatus}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Proof Source</label>
                        <div class="value">${proofSource}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Proof Timestamp</label>
                        <div class="value">${proofTimestamp}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Proof Evidence</label>
                        <div class="value">${proofEvidenceId}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Deliverability Risk</label>
                        <div class="value">${deliverabilityRisk}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Deliverability Reasons</label>
                        <div class="value">${deliverabilityReasons}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Model Route</label>
                        <div class="value">${modelRoute}</div>
                    </div>
                    <div class="sidebar-field">
                        <label>Compliance (Backend Verified)</label>
                        <div class="signal-checklist">${renderComplianceChecks(email.complianceChecks || {})}</div>
                    </div>

                    <div class="sidebar-field">
                        <label>Copy Quality Signals</label>
                        <div class="signal-checklist">${checksHtml}</div>
                    </div>

                    <div class="sidebar-title" style="margin-top: 24px;">Actions</div>
                    <button class="btn-sm btn-secondary" style="width:100%">ðŸ”— View LinkedIn</button>
                    <button class="btn-sm btn-secondary" style="width:100%; margin-top:8px;">ðŸ¢ View Website</button>
                </div>
            `;

            const bodyInput = document.getElementById('emailBodyInput');
            if (bodyInput) {
                bodyInput.innerHTML = renderEditableBodyHtml(email.body || 'No Body Content');
            }

            document.getElementById('emailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('emailModal').classList.remove('active');
            currentEmailId = null;
        }

        async function approveEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;
            const token = getToken({ promptFallback: true });
            const email = pendingEmails.find(e => e.id === emailId) || {};
            const rawEditedBody = (document.getElementById('emailBodyInput')?.innerText || '').trim();
            const editedBody = formatCopyForApproval(rawEditedBody, email);
            const feedback = document.getElementById('feedbackInput').value;

            try {
                const query = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/emails/${emailId}/approve${query}`, {
                    method: 'POST',
                    headers: buildAuthHeaders({ 'Content-Type': 'application/json' }, token),
                    body: JSON.stringify({
                        edited_body: editedBody,
                        feedback: feedback
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                closeModal();
                await fetchPendingEmails({ silent: true });
                showToast('Email approved');
            } catch (e) {
                alert('Error approving email: ' + e.message);
            }
        }

        async function rejectEmail() {
            if (!currentEmailId) return;

            // Save email ID before closing modal (closeModal sets currentEmailId to null)
            const emailId = currentEmailId;
            const feedback = (document.getElementById('feedbackInput')?.value || '').trim();
            const rejectionTag = (document.getElementById('rejectionTagInput')?.value || '').trim();
            if (!rejectionTag) {
                alert('Select a rejection tag before rejecting this email.');
                return;
            }
            if (!feedback) {
                alert('Add a short rejection reason so the system can learn.');
                return;
            }

            const token = getToken({ promptFallback: true });

            try {
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('reason', feedback);
                params.set('rejection_tag', rejectionTag);

                const response = await fetch(`/api/emails/${emailId}/reject?${params.toString()}`, {
                    method: 'POST',
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error (${response.status})`);
                }

                closeModal();
                await fetchPendingEmails({ silent: true });
                showToast('Email rejected');
            } catch (e) {
                alert('Error rejecting email: ' + e.message);
            }
        }

        // ============================================================
        // TAB ROUTING
        // ============================================================
        let activeTab = 'overview';
        const TAB_MAP = {
            overview: 'tab-overview',
            emails: 'tab-emails',
            campaigns: 'tab-campaigns',
            settings: 'tab-settings'
        };

        function showTab(tab) {
            activeTab = tab;
            // Toggle nav active state
            document.querySelectorAll('.nav-tab').forEach((t, i) => {
                const tabNames = ['overview', 'emails', 'campaigns', 'settings'];
                t.classList.toggle('active', tabNames[i] === tab);
            });
            // Toggle content panels
            Object.entries(TAB_MAP).forEach(([key, id]) => {
                const panel = document.getElementById(id);
                if (panel) {
                    panel.classList.toggle('active', key === tab);
                }
            });
            // Update URL hash
            window.location.hash = tab;
            // Fetch data for the activated tab
            onTabActivated(tab);
        }

        function onTabActivated(tab) {
            switch (tab) {
                case 'overview':
                    fetchScorecard();
                    fetchAgents();
                    fetchFunnel();
                    fetchConstraint();
                    fetchRecentActions();
                    break;
                case 'emails':
                    fetchPendingEmails({ silent: true });
                    fetchReviewedHistory();
                    break;
                case 'campaigns':
                    fetchOperatorHistory();
                    fetchCadenceSummary();
                    fetchQueueStatus();
                    break;
                case 'settings':
                    fetchSettingsData();
                    break;
            }
        }

        // On page load, read hash to set initial tab
        function initTabFromHash() {
            const hash = window.location.hash.replace('#', '');
            if (TAB_MAP[hash]) {
                showTab(hash);
            }
        }

        let constraintData = null;

        function viewConstraintFix() {
            if (constraintData && constraintData.recommendation) {
                alert('Recommendation: ' + constraintData.recommendation);
            } else {
                alert('No constraint recommendation available. All metrics may be on target.');
            }
        }

        function snoozeConstraint() {
            document.getElementById('constraintBanner').style.display = 'none';
            showToast('Constraint snoozed for 24 hours');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid var(--border);
                font-size: 14px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        let currentFilter = 'all';

        function classifyPriority(email) {
            const tier = (email.tier || 'tier_3').toLowerCase();
            let employees = 0;

            if (email.employees) {
                const empStr = String(email.employees);
                const parsed = parseInt(empStr.split('-')[0].replace(/,/g, ''));
                employees = isNaN(parsed) ? 0 : parsed;
            }

            if (tier === 'tier_1' && employees >= 50) return 'hot';
            if (tier === 'tier_1' || tier === 'tier_2') return 'warm';
            return 'low';
        }

        function filterEmails(priority) {
            currentFilter = priority;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPendingEmails();
        }

        async function bulkApprove() {
            const lowPriorityEmails = pendingEmails.filter(e => classifyPriority(e) === 'low');

            if (lowPriorityEmails.length === 0) {
                showToast('No low priority emails to approve');
                return;
            }

            if (!confirm(`Approve ${lowPriorityEmails.length} low priority emails?`)) return;

            let approved = 0;
            const token = getToken({ promptFallback: true });
            for (const email of lowPriorityEmails) {
                try {
                    const query = token ? `?token=${encodeURIComponent(token)}` : '';
                    const response = await fetch(`/api/emails/${email.id}/approve${query}`, {
                        method: 'POST',
                        headers: buildAuthHeaders({ 'Content-Type': 'application/json' }, token),
                        body: JSON.stringify({ feedback: 'bulk_approved_low_priority' })
                    });
                    if (response.ok) approved++;
                } catch (e) {
                    console.error('Bulk approve error:', e);
                }
            }

            showToast(`âœ… Approved ${approved} emails`);
            await fetchPendingEmails({ silent: true });
        }

        function getPriorityBadge(email) {
            const priority = classifyPriority(email);
            switch (priority) {
                case 'hot': return '<span class="priority-hot">ðŸ”´ HOT</span>';
                case 'warm': return '<span class="priority-warm">ðŸŸ¡ WARM</span>';
                case 'low': return '<span class="priority-low">ðŸŸ¢ LOW</span>';
                default: return '';
            }
        }

        async function fetchOperatorStatus() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                const response = await fetch(`/api/operator/status?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();

                const ramp = data.ramp || {};
                const banner = document.getElementById('rampBanner');

                if (ramp.active) {
                    banner.classList.add('active');
                    const dayText = ramp.day || 0;
                    const totalDays = ramp.remaining_days ? (dayText + ramp.remaining_days - 1) : 3;
                    document.getElementById('rampDay').textContent = `${dayText}/${totalDays}`;
                    document.getElementById('rampLimit').textContent = ramp.email_limit_override || '-';
                    document.getElementById('rampTier').textContent = (ramp.tier_filter || 'all').toUpperCase().replace('_', ' ');
                    document.getElementById('rampDetail').textContent =
                        `Day ${dayText} of ${totalDays} supervised days. Only ${(ramp.tier_filter || 'all').toUpperCase().replace('_', ' ')} leads at ${ramp.email_limit_override || '?'}/day.`;

                    // Update sent today from warmup schedule
                    const emailSchedule = data.warmup_schedule?.email || {};
                    const used = emailSchedule.used_today || 0;
                    const limit = emailSchedule.daily_limit || ramp.email_limit_override || 5;
                    document.getElementById('rampSent').textContent = `${used}/${limit}`;
                } else if (ramp.enabled === false) {
                    banner.classList.remove('active');
                }
            } catch (e) {
                console.warn('Failed to fetch operator status:', e);
            }
        }

        // ============================================================
        // OVERVIEW: Fetch Scorecard KPIs
        // ============================================================
        async function fetchScorecard() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/scorecard${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                const metrics = data.metrics || [];

                // Map scorecard metrics to cards
                const metricMap = {};
                metrics.forEach(m => { metricMap[m.metric || m.name] = m; });

                function updateCard(elemId, targetId, trendId, metric, formatFn) {
                    const el = document.getElementById(elemId);
                    const tEl = document.getElementById(targetId);
                    const trEl = document.getElementById(trendId);
                    if (!el || !metric) return;
                    const val = formatFn ? formatFn(metric.current || metric.value || 0) : (metric.current || metric.value || '--');
                    el.textContent = val;
                    // Color based on target comparison
                    el.className = 'metric-value';
                    if (metric.status === 'green' || metric.status === 'on_target') el.classList.add('green');
                    else if (metric.status === 'yellow' || metric.status === 'at_risk') el.classList.add('yellow');
                    else if (metric.status === 'red' || metric.status === 'off_target') el.classList.add('red');
                    else el.classList.add('green'); // default
                    if (tEl && metric.target != null) tEl.textContent = `Target: ${metric.target}`;
                    if (trEl && metric.trend) {
                        const up = metric.trend > 0;
                        trEl.className = `metric-trend ${up ? 'up' : 'down'}`;
                        trEl.textContent = `${up ? 'â†‘' : 'â†“'} ${Math.abs(metric.trend)}% vs last period`;
                    }
                }

                // Find relevant metrics by common naming patterns
                const emailMetric = metricMap['lead_velocity'] || metricMap['emails_sent'] || metricMap['email_volume'] || metrics[0];
                const replyMetric = metricMap['reply_rate'] || metricMap['response_rate'] || metrics.find(m => /reply/i.test(m.metric || m.name || ''));
                const meetingMetric = metricMap['meeting_book_rate'] || metricMap['meetings_booked'] || metrics.find(m => /meeting/i.test(m.metric || m.name || ''));
                const pipelineMetric = metricMap['pipeline_value'] || metricMap['close_rate'] || metrics.find(m => /pipeline|revenue/i.test(m.metric || m.name || ''));

                updateCard('emailsSent', 'emailsSentTarget', 'emailsSentTrend', emailMetric, v => String(v));
                updateCard('replyRate', 'replyRateTarget', 'replyRateTrend', replyMetric, v => typeof v === 'number' && v < 1 ? (v * 100).toFixed(1) + '%' : v + '%');
                updateCard('meetingsBooked', 'meetingsBookedTarget', 'meetingsBookedTrend', meetingMetric, v => String(v));
                updateCard('pipelineValue', 'pipelineValueTarget', 'pipelineValueTrend', pipelineMetric, v => typeof v === 'number' && v > 1000 ? '$' + (v / 1000).toFixed(0) + 'K' : '$' + v);
            } catch (e) {
                console.warn('fetchScorecard error:', e);
            }
        }

        // ============================================================
        // OVERVIEW: Fetch Constraint
        // ============================================================
        async function fetchConstraint() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/scorecard/constraint${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                constraintData = data;
                const banner = document.getElementById('constraintBanner');
                const msg = document.getElementById('constraintMessage');
                if (data.constraint && data.message) {
                    msg.textContent = data.message;
                    banner.classList.remove('success');
                } else {
                    msg.textContent = 'All metrics on target';
                    banner.classList.add('success');
                }
            } catch (e) {
                console.warn('fetchConstraint error:', e);
            }
        }

        // ============================================================
        // OVERVIEW: Fetch Agent Health
        // ============================================================
        async function fetchAgents() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/agents${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                const agents = data.agents || {};
                const grid = document.getElementById('agentGrid');
                if (!grid) return;

                const agentNames = Object.keys(agents);
                if (agentNames.length === 0) {
                    grid.innerHTML = '<div style="color: var(--text-muted); padding: 12px;">No agent data available</div>';
                    return;
                }

                grid.innerHTML = agentNames.map(name => {
                    const agent = agents[name] || {};
                    const health = (agent.health || agent.status || 'unknown').toLowerCase();
                    let dotClass = 'degraded';
                    let statusLabel = health;
                    if (health === 'healthy' || health === 'ok' || health === 'active') { dotClass = 'healthy'; statusLabel = 'Healthy'; }
                    else if (health === 'degraded' || health === 'warning') { dotClass = 'degraded'; statusLabel = 'Degraded'; }
                    else if (health === 'down' || health === 'error' || health === 'critical') { dotClass = 'down'; statusLabel = 'Down'; }

                    const successRate = agent.success_rate != null ? `${agent.success_rate}%` : '';
                    const errors = agent.error_count || agent.errors || 0;

                    return `<div class="agent-card">
                        <span class="agent-dot ${dotClass}"></span>
                        <div>
                            <div class="agent-name">${escapeHtml(name)}</div>
                            <div class="agent-meta">${statusLabel}${successRate ? ' Â· ' + successRate + ' success' : ''}${errors > 0 ? ' Â· ' + errors + ' errors' : ''}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.warn('fetchAgents error:', e);
            }
        }

        // ============================================================
        // OVERVIEW: Fetch Pipeline Funnel
        // ============================================================
        const FUNNEL_COLORS = ['#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'];

        async function fetchFunnel() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/leads/funnel${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                const funnel = data.funnel || data;

                const bar = document.getElementById('funnelBar');
                const labels = document.getElementById('funnelLabels');
                if (!bar || !labels) return;

                // Extract stages from funnel data
                const stages = [];
                const stageOrder = ['discovered', 'enriched', 'segmented', 'scored', 'queued', 'sent', 'replied', 'meeting'];
                stageOrder.forEach(key => {
                    if (funnel[key] != null) stages.push({ name: key, count: funnel[key] });
                });
                // If no ordered keys found, use whatever keys exist
                if (stages.length === 0) {
                    Object.entries(funnel).forEach(([key, val]) => {
                        if (typeof val === 'number') stages.push({ name: key, count: val });
                    });
                }

                if (stages.length === 0) {
                    bar.innerHTML = '<div style="padding: 12px; color: var(--text-muted); text-align: center; width: 100%;">No funnel data</div>';
                    labels.innerHTML = '';
                    return;
                }

                const maxCount = Math.max(...stages.map(s => s.count), 1);
                bar.innerHTML = stages.map((s, i) => {
                    const pct = Math.max((s.count / maxCount) * 100, 5); // min 5% width
                    const color = FUNNEL_COLORS[i % FUNNEL_COLORS.length];
                    return `<div class="funnel-segment" style="flex: ${pct}; background: ${color};">${s.count}</div>`;
                }).join('');

                labels.innerHTML = stages.map(s => {
                    return `<div class="funnel-label"><span class="count">${s.count}</span>${s.name}</div>`;
                }).join('');
            } catch (e) {
                console.warn('fetchFunnel error:', e);
            }
        }

        // ============================================================
        // OVERVIEW: Fetch Recent Actions
        // ============================================================
        async function fetchRecentActions() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('limit', '10');
                const response = await fetch(`/api/actions?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                const actions = data.actions || [];

                const feed = document.getElementById('activityFeed');
                if (!feed) return;

                if (actions.length === 0) {
                    feed.innerHTML = `<div class="activity-item">
                        <div class="activity-text"><p>Swarm is running. Waiting for activity...</p><span id="activityModeLabel">Live Mode</span></div>
                    </div>`;
                    return;
                }

                feed.innerHTML = actions.slice(0, 10).map(act => {
                    const time = act.timestamp ? new Date(act.timestamp).toLocaleString() : 'recently';
                    const status = (act.status || 'info').toLowerCase();
                    const iconClass = status === 'error' ? 'error' : status === 'warning' ? 'warning' : 'sent';
                    return `<div class="activity-item">
                        <div class="activity-icon ${iconClass}">${status === 'error' ? 'X' : status === 'warning' ? '!' : '>'}</div>
                        <div class="activity-text">
                            <p>${escapeHtml(act.action || act.message || 'Action')}</p>
                            <span>${escapeHtml(time)}</span>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.warn('fetchRecentActions error:', e);
                // Keep existing placeholder
            }
        }

        // ============================================================
        // EMAIL QUEUE: Fetch Reviewed History
        // ============================================================
        async function fetchReviewedHistory() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('include_non_dispatchable', 'true');
                const response = await fetch(`/api/emails/history?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                const container = document.getElementById('reviewedHistory');
                if (!response.ok) {
                    // Fallback: try queue-status for basic counts
                    if (container) container.innerHTML = '<div style="padding: 16px; color: var(--text-muted); text-align: center;">History endpoint not available</div>';
                    return;
                }
                const data = await response.json();
                const emails = data.emails || [];

                if (!container) return;
                if (emails.length === 0) {
                    container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No reviewed emails yet</div>';
                    return;
                }

                container.innerHTML = emails.map(e => {
                    const statusClass = (e.status || '').toLowerCase();
                    const statusLabel = statusClass === 'approved' ? 'APPROVED' : statusClass === 'rejected' ? 'REJECTED' : (e.status || '').toUpperCase();
                    const time = e.reviewed_at || e.timestamp || '';
                    const timeStr = time ? new Date(time).toLocaleString() : '';
                    return `<div class="history-item">
                        <div>
                            <span style="color: var(--text-primary);">${escapeHtml(e.to || e.email_id || '--')}</span>
                            <span style="color: var(--text-muted); margin-left: 8px;">${escapeHtml(e.subject || '')}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:12px; color:var(--text-muted);">${escapeHtml(timeStr)}</span>
                            <span class="history-status ${statusClass}">${statusLabel}</span>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.warn('fetchReviewedHistory error:', e);
            }
        }

        // ============================================================
        // CAMPAIGNS: Fetch Operator Dispatch History
        // ============================================================
        async function fetchOperatorHistory() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('limit', '50');
                const response = await fetch(`/api/operator/history?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) {
                    document.getElementById('dispatchTableBody').innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--text-muted); padding: 24px;">Unable to load dispatch history</td></tr>`;
                    return;
                }
                const data = await response.json();
                const history = data.history || [];

                const tbody = document.getElementById('dispatchTableBody');
                if (!tbody) return;

                if (history.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--text-muted); padding: 24px;">No dispatch history yet</td></tr>`;
                    // Update 7d total
                    const el = document.getElementById('totalDispatched7d');
                    if (el) el.textContent = '0';
                    return;
                }

                tbody.innerHTML = history.map(h => {
                    const time = h.timestamp ? new Date(h.timestamp).toLocaleString() : '--';
                    const motion = h.motion || h.type || 'unknown';
                    const count = h.dispatched || h.count || 0;
                    const platform = h.platform || h.channel || '--';
                    const result = (h.result || h.status || 'unknown').toLowerCase();
                    let badgeClass = 'badge-success';
                    if (result.includes('fail') || result.includes('error')) badgeClass = 'badge-failed';
                    else if (result.includes('partial') || result.includes('warn')) badgeClass = 'badge-partial';
                    return `<tr>
                        <td>${escapeHtml(time)}</td>
                        <td><span class="badge-motion">${escapeHtml(motion)}</span></td>
                        <td>${count}</td>
                        <td>${escapeHtml(platform)}</td>
                        <td><span class="${badgeClass}">${escapeHtml(result)}</span></td>
                    </tr>`;
                }).join('');

                // Calculate 7d total
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                const total7d = history
                    .filter(h => h.timestamp && new Date(h.timestamp).getTime() > sevenDaysAgo)
                    .reduce((sum, h) => sum + (h.dispatched || h.count || 0), 0);
                const el = document.getElementById('totalDispatched7d');
                if (el) el.textContent = String(total7d);
            } catch (e) {
                console.warn('fetchOperatorHistory error:', e);
            }
        }

        // ============================================================
        // CAMPAIGNS: Fetch Cadence Summary
        // ============================================================
        async function fetchCadenceSummary() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/cadence/summary${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();

                const activeEl = document.getElementById('cadenceActive');
                const dueEl = document.getElementById('cadenceDueToday');
                if (activeEl) activeEl.textContent = String(data.active || 0);
                if (dueEl) dueEl.textContent = String(data.due_today || 0);

                // Populate cadence pipeline section
                fetchCadenceLeads();
            } catch (e) {
                console.warn('fetchCadenceSummary error:', e);
            }
        }

        async function fetchCadenceLeads() {
            try {
                const token = getToken({ promptFallback: false });
                const params = new URLSearchParams();
                if (token) params.set('token', token);
                params.set('status', 'active');
                const response = await fetch(`/api/cadence/leads?${params.toString()}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const leads = await response.json();
                const container = document.getElementById('cadencePipeline');
                if (!container) return;

                const leadList = Array.isArray(leads) ? leads : (leads.leads || []);
                if (leadList.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color: var(--text-muted); padding: 24px;">No active cadence enrollments</div>';
                    return;
                }

                // Group by current step
                const byStep = {};
                leadList.forEach(l => {
                    const step = l.current_step || l.step || 0;
                    if (!byStep[step]) byStep[step] = [];
                    byStep[step].push(l);
                });

                let html = '';
                Object.keys(byStep).sort((a, b) => Number(a) - Number(b)).forEach(step => {
                    const group = byStep[step];
                    html += `<div style="margin-bottom: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--blue); margin-bottom: 8px;">Step ${step} (${group.length} leads)</div>`;
                    html += group.slice(0, 10).map(l => {
                        const email = l.email || l.lead_email || '--';
                        const company = l.company || '--';
                        const channel = l.channel || l.next_channel || '--';
                        const day = l.day || l.cadence_day || '--';
                        return `<div class="history-item">
                            <span style="color: var(--text-primary);">${escapeHtml(email)}</span>
                            <span style="color: var(--text-muted);">${escapeHtml(company)} Â· Day ${day} Â· ${escapeHtml(channel)}</span>
                        </div>`;
                    }).join('');
                    if (group.length > 10) html += `<div style="padding: 8px 16px; font-size: 12px; color: var(--text-muted);">+${group.length - 10} more</div>`;
                    html += '</div>';
                });
                container.innerHTML = html;
            } catch (e) {
                console.warn('fetchCadenceLeads error:', e);
            }
        }

        // ============================================================
        // CAMPAIGNS: Fetch Queue Status (for Sent Today card)
        // ============================================================
        async function fetchQueueStatus() {
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/queue-status${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (!response.ok) return;
                const data = await response.json();
                const limits = data.daily_limits || {};
                const sentEl = document.getElementById('campaignSentToday');
                const limitEl = document.getElementById('campaignSentLimit');
                if (sentEl) sentEl.textContent = String(limits.sent_today || 0);
                if (limitEl) limitEl.textContent = `Limit: ${limits.limit || '?'} / Remaining: ${limits.remaining || '?'}`;
            } catch (e) {
                console.warn('fetchQueueStatus error:', e);
            }
        }

        // ============================================================
        // SETTINGS: Fetch all settings data
        // ============================================================
        async function fetchSettingsData() {
            // Fetch operator status for ramp info
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/operator/status${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (response.ok) {
                    const data = await response.json();
                    const ramp = data.ramp || {};

                    document.getElementById('settingsRampStatus').innerHTML = ramp.active
                        ? '<span class="status-indicator warn"><span class="dot"></span> ACTIVE</span>'
                        : '<span class="status-indicator ok"><span class="dot"></span> INACTIVE</span>';
                    document.getElementById('settingsRampDay').textContent = ramp.day ? `Day ${ramp.day}` : 'N/A';
                    document.getElementById('settingsRampTier').textContent = (ramp.tier_filter || 'all').toUpperCase().replace('_', ' ');
                    document.getElementById('settingsRampLimit').textContent = ramp.email_limit_override || 'N/A';

                    // Ramp progress indicator
                    const progressBar = document.getElementById('rampProgressBar');
                    if (progressBar && ramp.active) {
                        const totalDays = ramp.remaining_days ? (ramp.day + ramp.remaining_days - 1) : 3;
                        let html = '';
                        for (let d = 1; d <= totalDays; d++) {
                            const cls = d < ramp.day ? 'complete' : d === ramp.day ? 'current' : '';
                            html += `<div class="ramp-step ${cls}">${d}</div>`;
                            if (d < totalDays) html += `<div class="ramp-connector ${d < ramp.day ? 'complete' : ''}"></div>`;
                        }
                        progressBar.innerHTML = html;
                    }
                }
            } catch (e) {
                console.warn('fetchSettingsData (operator) error:', e);
            }

            // Fetch dependencies
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/runtime/dependencies${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (response.ok) {
                    const data = await response.json();
                    const redisEl = document.getElementById('settingsRedis');
                    const inngestEl = document.getElementById('settingsInngest');
                    const redisOk = data.redis?.connected || data.redis?.status === 'ok';
                    const inngestOk = data.inngest?.connected || data.inngest?.status === 'ok';
                    if (redisEl) redisEl.innerHTML = redisOk
                        ? '<span class="dot"></span> Connected'
                        : '<span class="dot"></span> Disconnected';
                    if (redisEl) redisEl.className = `status-indicator ${redisOk ? 'ok' : 'error'}`;
                    if (inngestEl) inngestEl.innerHTML = inngestOk
                        ? '<span class="dot"></span> Connected'
                        : '<span class="dot"></span> Disconnected';
                    if (inngestEl) inngestEl.className = `status-indicator ${inngestOk ? 'ok' : 'error'}`;
                }
            } catch (e) {
                console.warn('fetchSettingsData (deps) error:', e);
            }

            // Fetch guardrails
            try {
                const token = getToken({ promptFallback: false });
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const response = await fetch(`/api/guardrails${params}`, {
                    headers: buildAuthHeaders({}, token)
                });
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('settingsGuardrails');
                    if (!container) return;
                    const guardrails = data.guardrails || {};
                    const rateLimits = data.rate_limits || {};
                    const emailLimits = data.email_limits || {};

                    let html = '';
                    // Guardrails
                    Object.entries(guardrails).forEach(([key, val]) => {
                        html += `<div class="setting-row"><span class="setting-label">${escapeHtml(key)}</span><span class="setting-value">${escapeHtml(String(val))}</span></div>`;
                    });
                    // Rate limits
                    if (Object.keys(rateLimits).length > 0) {
                        html += '<div style="margin-top: 12px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Rate Limits</div>';
                        Object.entries(rateLimits).forEach(([key, val]) => {
                            const display = typeof val === 'object' ? JSON.stringify(val) : String(val);
                            html += `<div class="setting-row"><span class="setting-label">${escapeHtml(key)}</span><span class="setting-value">${escapeHtml(display)}</span></div>`;
                        });
                    }
                    // Email limits
                    if (Object.keys(emailLimits).length > 0) {
                        html += '<div style="margin-top: 12px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Email Limits</div>';
                        Object.entries(emailLimits).forEach(([key, val]) => {
                            html += `<div class="setting-row"><span class="setting-label">${escapeHtml(key)}</span><span class="setting-value">${escapeHtml(String(val))}</span></div>`;
                        });
                    }
                    container.innerHTML = html || '<div style="color: var(--text-muted);">No guardrails data</div>';
                }
            } catch (e) {
                console.warn('fetchSettingsData (guardrails) error:', e);
            }
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        renderPendingEmails();
        renderActivityFeed();
        fetchOperatorStatus();

        // Set initial tab from URL hash, then start data fetching
        initTabFromHash();

        // Auto-refresh for active tab
        setInterval(() => {
            if (activeTab === 'emails') fetchPendingEmails({ silent: true });
            if (activeTab === 'overview') { fetchScorecard(); fetchAgents(); }
        }, 30000);

        setInterval(() => {
            fetchOperatorStatus(); // global ramp banner
            if (activeTab === 'campaigns') { fetchOperatorHistory(); fetchCadenceSummary(); }
            if (activeTab === 'settings') fetchSettingsData();
        }, 60000);

        // Refresh heartbeat: update countdown + last refresh label
        let lastRefreshTime = Date.now();
        setInterval(() => {
            if (activeTab === 'emails') {
                const elapsed = Math.round((Date.now() - lastRefreshTime) / 1000);
                const remaining = Math.max(0, Math.round(REFRESH_INTERVAL_MS / 1000) - elapsed);
                const labelEl = document.getElementById('lastRefreshLabel');
                const countEl = document.getElementById('nextPollCountdown');
                if (labelEl && lastRefreshAt) labelEl.textContent = new Date(lastRefreshAt).toLocaleTimeString();
                if (countEl) countEl.textContent = String(remaining);
            }
        }, 1000);

        // Listen for hash changes (browser back button)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.replace('#', '');
            if (TAB_MAP[hash] && hash !== activeTab) {
                showTab(hash);
            }
        });

        // Initial data fetch for default tab
        if (activeTab === 'overview') {
            fetchScorecard();
            fetchAgents();
            fetchFunnel();
            fetchConstraint();
            fetchRecentActions();
        }

        // Start email queue auto-refresh (for when Email Queue tab is active)
        startAutoRefresh();
    </script>
</body>

</html>
