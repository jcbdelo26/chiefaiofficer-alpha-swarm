#!/usr/bin/env bash
# Pre-commit hook: runs curated Phase 4 tests before every commit (~10-30s)
# Install: git config core.hooksPath .githooks
#
# Runs known-good tests covering critical Phase 4 modules.
# For full suite: python -m pytest tests/ -v -s

set -e

echo "Running pre-commit tests..."

# Curated test files: Phase 4 modules + core pipeline
python -m pytest \
  tests/test_heyreach_dispatcher.py \
  tests/test_heyreach_webhook.py \
  tests/test_enricher_waterfall.py \
  tests/test_quality_guard.py \
  tests/test_rejection_memory.py \
  tests/test_shadow_queue.py \
  tests/test_pipeline_integration.py \
  tests/test_feedback_loop.py \
  tests/test_feedback_loop_trace.py \
  tests/test_instantly_dispatcher_guards.py \
  tests/test_instantly_webhook_auth.py \
  tests/test_crafter_rejection_hardening.py \
  tests/test_task_routing_policy.py \
  tests/test_phase1_proof_deliverability.py \
  tests/test_phase1_feedback_loop_integration.py \
  tests/test_cadence_engine.py \
  tests/test_operator_partial_dispatch.py \
  tests/test_operator_lock_safety.py \
  tests/test_dashboard_ghl_transaction.py \
  tests/test_enricher_timeout.py \
  tests/test_operator_dedup_and_send_path.py \
  tests/test_operator_ramp_logic.py \
  tests/test_webhook_signature_enforcement.py \
  tests/test_state_store_redis_cutover.py \
  tests/test_health_monitor.py \
  tests/test_gatekeeper_integration.py \
  tests/test_dashboard_login.py \
  -x -q --tb=short -s 2>/dev/null

if [ $? -ne 0 ]; then
    echo ""
    echo "PRE-COMMIT HOOK FAILED: Tests must pass before committing."
    echo "Run 'python -m pytest tests/ -v -s' for details."
    exit 1
fi

echo "All pre-commit tests passed."
