============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\Agent Swarm Orchestration\chiefaiofficer-alpha-swarm
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 6 items

tests/test_unified_swarm.py::test_queen_routing_schedule PASSED          [ 16%]
tests/test_unified_swarm.py::test_scheduler_availability_check PASSED    [ 33%]
tests/test_unified_swarm.py::test_scheduler_book_meeting FAILED          [ 50%]
tests/test_unified_swarm.py::test_researcher_company_intel PASSED        [ 66%]
tests/test_unified_swarm.py::test_researcher_attendee_enrichment PASSED  [ 83%]
tests/test_unified_swarm.py::test_gatekeeper_queue_add FAILED            [100%]

================================== FAILURES ===================================
_________________________ test_scheduler_book_meeting _________________________

scheduler = <execution.scheduler_agent.SchedulerAgent object at 0x00000195ADECA490>

    @pytest.mark.asyncio
    async def test_scheduler_book_meeting(scheduler):
        """Verify booking creates event."""
        # Ensure success is True
        scheduler.calendar.create_event = AsyncMock(return_value={"success": True, "id": "evt_123", "htmlLink": "link"})
    
        res = await scheduler.book_meeting(
            "john@example.com",
            "2026-01-24T10:00:00-05:00",
            30,
            "Discovery",
            with_zoom=True
        )
    
        # BookingResult is a dataclass, use attribute access
>       assert res.event_id == "evt_123"
E       AssertionError: assert None == 'evt_123'
E        +  where None = BookingResult(success=True, event_id=None, calendar_link=None, zoom_link='https://zoom.us/j/406DA1F4', start_time='2026-01-24T10:00:00-05:00', end_time='2026-01-24T10:30:00-05:00', error=None, warnings=[]).event_id

tests\test_unified_swarm.py:118: AssertionError
__________________________ test_gatekeeper_queue_add __________________________

gatekeeper = <execution.gatekeeper_queue.EnhancedGatekeeperQueue object at 0x00000195ADF03620>

    @pytest.mark.asyncio
    async def test_gatekeeper_queue_add(gatekeeper):
        """Verify adding item to queue creates pending review."""
        item_tuple = ReviewItem(
            review_id="rev_001",
            campaign_id="camp_001",
            campaign_name="Test Campaign",
            campaign_type="outbound",
            lead_count=100,
            avg_icp_score=0.9,
            segment="Tech CEOs",
            email_preview={"subject": "Hi", "body": "Hello"},
            status="pending",
            queued_at="2026-01-24T10:00:00Z"
        )
    
        # Mock ApprovalEngine inside gatekeeper to ensure it returns NOT auto-approved
        # We patch the instance method. submit_request returns ApprovalRequest object.
        mock_req = ApprovalRequest(
            request_id="req_123",
            status="pending",
            requester_agent="gatekeeper",
            action_type="bulk_email",
            payload={},
            risk_score=0.9,
            created_at="now",
            updated_at="now"
        )
    
        # gatekeeper.approval_engine is initialized in __init__
        # We replace submit_request method with MagicMock since it's sync
        gatekeeper.approval_engine.submit_request = MagicMock(return_value=mock_req)
    
        review_id = await gatekeeper.submit_for_review(item_tuple)
    
        assert review_id is not None
    
        # Verify it's in the pending list
        pending = gatekeeper.get_pending()
>       assert len(pending) == 1
E       AssertionError: assert 9 == 1
E        +  where 9 = len([ReviewItem(review_id='rev_001', campaign_id='camp_001', campaign_name='Test Campaign', campaign_type='outbound', lead_count=100, avg_icp_score=0.9, segment='Tech CEOs', email_preview={'subject': 'Hi', 'body': 'Hello'}, status='pending', queued_at='2026-01-24T10:00:00Z', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='', rpi_workflow=False, urgency='normal', approval_request_id='req_123', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:00:13.217016+00:00', sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:23.874211+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='critical', approval_request_id='req_4f9b5137', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:00:23.879882+00:00', sms_sent_at='2026-01-22T21:00:23.879887+00:00', email_fallback_sent_at='2026-01-22T21:00:23.879889+00:00'), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T18:30:23.928172+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at='2026-01-22T21:00:23.928381+00:00'), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T20:15:23.959333+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='urgent', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at='2026-01-22T21:00:23.959510+00:00', email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:23.984946+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.011248+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.049016+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.208181+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='rev_001', campaign_id='camp_001', campaign_name='Test Campaign', campaign_type='outbound', lead_count=100, avg_icp_score=0.9, segment='Tech CEOs', email_preview={'subject': 'Hi', 'body': 'Hello'}, status='pending', queued_at='2026-01-24T10:00:00Z', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='', rpi_workflow=False, urgency='normal', approval_request_id='req_123', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:01:54.487821+00:00', sms_sent_at=None, email_fallback_sent_at=None)])

tests\test_unified_swarm.py:198: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  notifications:notifications.py:226 Slack notification failed: 404
=========================== short test summary info ===========================
FAILED tests/test_unified_swarm.py::test_scheduler_book_meeting - AssertionError: assert None == 'evt_123'
 +  where None = BookingResult(success=True, event_id=None, calendar_link=None, zoom_link='https://zoom.us/j/406DA1F4', start_time='2026-01-24T10:00:00-05:00', end_time='2026-01-24T10:30:00-05:00', error=None, warnings=[]).event_id
FAILED tests/test_unified_swarm.py::test_gatekeeper_queue_add - AssertionError: assert 9 == 1
 +  where 9 = len([ReviewItem(review_id='rev_001', campaign_id='camp_001', campaign_name='Test Campaign', campaign_type='outbound', lead_count=100, avg_icp_score=0.9, segment='Tech CEOs', email_preview={'subject': 'Hi', 'body': 'Hello'}, status='pending', queued_at='2026-01-24T10:00:00Z', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='', rpi_workflow=False, urgency='normal', approval_request_id='req_123', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:00:13.217016+00:00', sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:23.874211+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='critical', approval_request_id='req_4f9b5137', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:00:23.879882+00:00', sms_sent_at='2026-01-22T21:00:23.879887+00:00', email_fallback_sent_at='2026-01-22T21:00:23.879889+00:00'), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T18:30:23.928172+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at='2026-01-22T21:00:23.928381+00:00'), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T20:15:23.959333+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='urgent', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at='2026-01-22T21:00:23.959510+00:00', email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:23.984946+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.011248+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.049016+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='test-review-123', campaign_id='campaign-456', campaign_name='Test Campaign', campaign_type='email_sequence', lead_count=50, avg_icp_score=75.0, segment='enterprise', email_preview={'subject_a': 'Test Subject', 'subject_b': 'Test Subject B', 'body': 'Test body content...'}, status='pending', queued_at='2026-01-22T21:00:24.208181+00:00', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='tier2', rpi_workflow=True, urgency='normal', approval_request_id=None, approval_source=None, escalation_level=0, deadline=None, notification_sent_at=None, sms_sent_at=None, email_fallback_sent_at=None), ReviewItem(review_id='rev_001', campaign_id='camp_001', campaign_name='Test Campaign', campaign_type='outbound', lead_count=100, avg_icp_score=0.9, segment='Tech CEOs', email_preview={'subject': 'Hi', 'body': 'Hello'}, status='pending', queued_at='2026-01-24T10:00:00Z', reviewed_at=None, reviewed_by=None, rejection_reason=None, edits=None, expires_at=None, semantic_anchors=[], tier='', rpi_workflow=False, urgency='normal', approval_request_id='req_123', approval_source=None, escalation_level=0, deadline=None, notification_sent_at='2026-01-22T21:01:54.487821+00:00', sms_sent_at=None, email_fallback_sent_at=None)])
========================= 2 failed, 4 passed in 2.93s =========================
Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x00000195ADF02F90>
Unclosed connector
connections: ['deque([(<aiohttp.client_proto.ResponseHandler object at 0x00000195AE0196D0>, 731082.8694582)])']
connector: <aiohttp.connector.TCPConnector object at 0x00000195ADF00050>
